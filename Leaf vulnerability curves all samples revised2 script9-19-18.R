# # # Desktop
rm(list=ls())
getwd()
#load packages
library(RColorBrewer)
# stats package
library(dplyr)
library(reshape)
library(lme4)
library(lmerTest)
library(MuMIn)
library(stringr)
require(lmodel2)
library(car)
# install.packages("agricolae")
library(agricolae)

options(contrasts = c("contr.sum", "contr.poly"))
# Useful functions
se <- function(x) sqrt(var(x, na.rm=T)/sum(!is.na(x)))
cv <- function(x) sd(x, na.rm=TRUE)/abs(mean(x, na.rm=TRUE))*100

getwd()

addTrans <- function(color,trans)
{
  # This function adds transparancy to a color.
  # Define transparancy with an integer between 0 and 255
  # 0 being fully transparant and 255 being fully visable
  # Works with either color and trans a vector of equal length,
  # or one of the two of length 1.
  
  if (length(color)!=length(trans)&!any(c(length(color),length(trans))==1)) stop("Vector lengths not correct")
  if (length(color)==1 & length(trans)>1) color <- rep(color,length(trans))
  if (length(trans)==1 & length(color)>1) trans <- rep(trans,length(color))
  
  num2hex <- function(x)
  {
    hex <- unlist(strsplit("0123456789ABCDEF",split=""))
    return(paste(hex[(x-x%%16)/16+1],hex[x%%16+1],sep=""))
  }
  rgb <- rbind(col2rgb(color),trans)
  res <- paste("#",apply(apply(rgb,2,num2hex),2,paste,collapse=""),sep="")
  return(res)
}
# setwd("E:/")

all.ovc <- read.table("Finalrevised2analysis_Qd2018RPS.txt",header=T)
all.ovc.leaf <- all.ovc[all.ovc$tissue == "leaf",]
all.ovc.stem <- all.ovc[all.ovc$tissue %in% c("stem","Stem"),]
unique(all.ovc$popnumber)
unique(all.ovc$newpopnumber)
head(all.ovc)
##########
# Quercus douglasii
##########

#################################################################################################
# Question 1: Is there variation in vulnerability to embolism between populations of blue oaks? #
#################################################################################################

###############################################################################
###### Component 1A: Describe the variation in vulnerability to embolism ######
###############################################################################
###############################################################################
####################### And particularly for P50 ##############################
###############################################################################

# Hopland garden
tiff(filename = "Fig All VC.tif",
     width = 18, height = 12, units = "cm", pointsize = 8,
     compression = c("lzw"),
     bg = "white", res = 1200, family = "", restoreConsole = TRUE,
     type = c("windows", "cairo"),antialias = "cleartype")
par(mfrow = c(4,7),mar=c(1,1,0.1,0.1),oma=c(4,4,0.4,0.4))
# Stems
k <- 0
col.inds <- c("blue","red","black","blue","violet","pink","brown","yellow","orange")
hopland.stem <- all.ovc.stem[all.ovc.stem$site == "Hopland",]
tags <- unique(hopland.stem[,3])
pops <- sort(unique(hopland.stem[,11]))
ovc.data.individuals <- matrix(NA,nrow = length(tags),ncol=12)
ovc.data.individuals <- as.data.frame(ovc.data.individuals)
colnames(ovc.data.individuals) <- c("genus","species","site", "pop","individual","pe","p12","p50","p88","tissue","rand","ran")
inds.pop <- 1:length(pops)
letters <- c(letters, "aa","ab")
alet <- 0
l <- 0
for (j in c(pops)){
        alet <- alet+1
        k <- 0
        par(new=F)
# Find the unique individuals of each pop
        for (i in c(unique(hopland.stem[hopland.stem$newpopnumber == j,5]))){
                l <- l + 1
                k <- k + 1
                cols <- sample("firebrick",1500,TRUE)
                plot(hopland.stem$lwp_MPa[hopland.stem$newpopnumber == j & hopland.stem$individual == i],
                     hopland.stem$percentembolism_.[hopland.stem$newpopnumber == j & hopland.stem$individual == i],
                     col=addTrans(cols,80),yaxt="n",xlim=c(-8,0),ylim=c(0,100),ylab="",xlab="",xaxt="n",type="p",axes=F)
                x.1 <- hopland.stem$lwp_MPa[hopland.stem$newpopnumber == j & hopland.stem$individual == i]
                y.1 <- hopland.stem$percentembolism_.[hopland.stem$newpopnumber == j & hopland.stem$individual == i]
                b.val <- ifelse(j == 3 & k == 2,-5,-4)
                a.val <- ifelse(j == 3 & k == 2, -8,-6)
                plcmod_qd <- nls(y.1~100-100/(1+exp(a*(x.1-b))), start=list(a=a.val,b=b.val))
                xv.1 <- seq(from=-10,to=0,by=0.01)
                yv.1 <- predict(plcmod_qd,data.frame(x.1=xv.1))
                lines(xv.1,yv.1,col="black",lty=2)
                ovc.data.individuals[l,1] <- as.character(unique(hopland.stem$genus[hopland.stem$newpopnumber == j & hopland.stem$individual == i] ))
                ovc.data.individuals[l,2] <- as.character(unique(hopland.stem$species[hopland.stem$newpopnumber == j & hopland.stem$individual == i] ))
                ovc.data.individuals[l,3] <- "H"
                ovc.data.individuals[l,4] <- unique(hopland.stem$newpopnumber[hopland.stem$newpopnumber == j & hopland.stem$individual == i])
                ovc.data.individuals[l,5] <- unique(hopland.stem$individual[hopland.stem$newpopnumber == j & hopland.stem$individual == i])
                ovc.data.individuals[l,6] <- max(x.1[which(y.1 == min(y.1[y.1>5],na.rm=T))],na.rm=T)
                ### P12
                a <- coefficients(summary(plcmod_qd))[1]
                p50 <- coefficients(summary(plcmod_qd))[2]
                slope <- -100*a/4
                c <- (100/2) - slope*p50
                p88 <- -c/slope
                p12 <- (100-c)/slope
                ovc.data.individuals[l,7] <- p12
                # P50
                ovc.data.individuals[l,8] <- p50
                ### P88
                ovc.data.individuals[l,9] <- p88
                ovc.data.individuals[l,10] <- as.character(unique(hopland.stem$tissue[hopland.stem$newpopnumber == j & hopland.stem$individual == i] ))
                par(new=T)
        }
        ifelse(l < 6,axis(side=2, labels=T,tick=T,las=1),axis(side=2, labels=F,tick=T,las=1))
        axis(side=1, labels=F,tick=T)
        text(-7,20,j,cex=2,font=2)
        text(-0.1,95,letters[alet],font=2)
}
# Hopland
# Leaves
hopland.leaf <- all.ovc.leaf[all.ovc.leaf$site == "Hopland",]
head(hopland.leaf)
tags <- unique(hopland.leaf[,3])
# pops <- unique(hopland.leaf[,4])
k <- 0
inds.pop <- 1:length(pops)
for (j in c(pops)){
        alet <- alet+1
        k <- 0
        par(new=F)
        # Find the unique individuals of each pop
        for (i in c(unique(hopland.leaf[hopland.leaf$newpopnumber == j,5]))){
                l <- l + 1
                k <- k + 1
                cols <- sample("blue",1500,TRUE)
                plot(hopland.leaf$lwp_MPa[hopland.leaf$newpopnumber == j & hopland.leaf$individual == i],hopland.leaf$percentembolism_.[hopland.leaf$newpopnumber == j & hopland.leaf$individual == i],col=addTrans(cols,80),yaxt="n",xlim=c(-8,0),ylim=c(0,100),ylab="",xlab="",xaxt="n",type="p",axes=F)
                x.1 <- hopland.leaf$lwp_MPa[hopland.leaf$newpopnumber == j & hopland.leaf$individual == i]
                y.1 <- hopland.leaf$percentembolism_.[hopland.leaf$newpopnumber == j & hopland.leaf$individual == i]
                b.val <- ifelse(j == 3 & k == 2,-5,-4)
                a.val <- ifelse(j == 3 & k == 2, -8,-6)
                plcmod_qd <- nls(y.1~100-100/(1+exp(a*(x.1-b))), start=list(a=a.val,b=b.val))
                xv.1 <- seq(from=-10,to=0,by=0.01)
                yv.1 <- predict(plcmod_qd,data.frame(x.1=xv.1))
                lines(xv.1,yv.1,col="black",lty=2)
                ovc.data.individuals[l,1] <- as.character(unique(hopland.leaf$genus[hopland.leaf$newpopnumber == j & hopland.leaf$individual == i] ))
                ovc.data.individuals[l,2] <- as.character(unique(hopland.leaf$species[hopland.leaf$newpopnumber == j & hopland.leaf$individual == i] ))
                ovc.data.individuals[l,3] <- "H"
                ovc.data.individuals[l,4] <- unique(hopland.leaf$newpopnumber[hopland.leaf$newpopnumber == j & hopland.leaf$individual == i] )
                ovc.data.individuals[l,5] <- unique(hopland.leaf$individual[hopland.leaf$newpopnumber == j & hopland.leaf$individual == i] )
                ovc.data.individuals[l,6] <- max(x.1[which(y.1 == min(y.1[y.1>5],na.rm=T))],na.rm=T)
                ### P12
                a <- coefficients(summary(plcmod_qd))[1]
                p50 <- coefficients(summary(plcmod_qd))[2]
                slope <- -100*a/4
                c <- (100/2) - slope*p50
                p88 <- -c/slope
                p12 <- (100-c)/slope
                ovc.data.individuals[l,7] <- p12
                # P50
                ovc.data.individuals[l,8] <- p50
                ### P88
                ovc.data.individuals[l,9] <- p88
                ovc.data.individuals[l,10] <- as.character(unique(hopland.leaf$tissue[hopland.leaf$newpopnumber == j & hopland.leaf$individual == i] ))
                par(new=T)      
        }
        ifelse(l < 37,axis(side=2, labels=T,tick=T,las=1),axis(side=2, labels=F,tick=T,las=1))
        axis(side=1, labels=F,tick=T)
        text(-7,20,j,cex=2,font=2)
        text(-0.1,95,letters[alet],font=2)
}

# Wild pops
# Stems
col.inds <- c("blue","red","black","blue","violet","pink","brown","yellow","orange")
wild.stem <- all.ovc.stem[all.ovc.stem$site == "Wild",]
tags <- unique(wild.stem[,3])
# pops <- unique(wild.stem[,4])
inds.pop <- 1:length(pops)
for (j in c(pops)){
        alet <- alet+1
        k <- 0
        par(new=F)
        # Find the unique individuals of each pop
        for (i in c(unique(wild.stem[wild.stem$newpopnumber == j,5]))){
                l <- l + 1
                k <- k + 1
                cols <- sample("firebrick",1500,TRUE)
                plot(wild.stem$lwp_MPa[wild.stem$newpopnumber == j & wild.stem$individual == i],wild.stem$percentembolism_.[wild.stem$newpopnumber == j & wild.stem$individual == i],col=addTrans(cols,80),yaxt="n",xlim=c(-8,0),ylim=c(0,100),ylab="",xlab="",xaxt="n",type="p",axes=F)
                x.1 <- wild.stem$lwp_MPa[wild.stem$newpopnumber == j & wild.stem$individual == i]
                y.1 <- wild.stem$percentembolism_.[wild.stem$newpopnumber == j & wild.stem$individual == i]
                b.val <- ifelse(j == 3 & k == 2,-5,-4)
                a.val <- ifelse(j == 3 & k == 2, -8,-6)
                plcmod_qd <- nls(y.1~100-100/(1+exp(a*(x.1-b))), start=list(a=a.val,b=b.val))
                xv.1 <- seq(from=-10,to=0,by=0.01)
                yv.1 <- predict(plcmod_qd,data.frame(x.1=xv.1))
                lines(xv.1,yv.1,col="black",lty=2)
                ovc.data.individuals[l,1] <- as.character(unique(wild.stem$genus[wild.stem$newpopnumber == j & wild.stem$individual == i] ))
                ovc.data.individuals[l,2] <- as.character(unique(wild.stem$species[wild.stem$newpopnumber == j & wild.stem$individual == i] ))
                ovc.data.individuals[l,3] <- "W"
                ovc.data.individuals[l,4] <- unique(wild.stem$newpopnumber[wild.stem$newpopnumber == j & wild.stem$individual == i] )
                ovc.data.individuals[l,5] <- unique(wild.stem$individual[wild.stem$newpopnumber == j & wild.stem$individual == i] )
                ovc.data.individuals[l,6] <- max(x.1[which(y.1 == min(y.1[y.1>5],na.rm=T))],na.rm=T)
                ### P12
                a <- coefficients(summary(plcmod_qd))[1]
                p50 <- coefficients(summary(plcmod_qd))[2]
                slope <- -100*a/4
                c <- (100/2) - slope*p50
                p88 <- -c/slope
                p12 <- (100-c)/slope
                ovc.data.individuals[l,7] <- p12
                # P50
                ovc.data.individuals[l,8] <- p50
                ### P88
                ovc.data.individuals[l,9] <- p88
                ovc.data.individuals[l,10] <- as.character(unique(wild.stem$tissue[wild.stem$newpopnumber == j & wild.stem$individual == i] ))
                par(new=T)
        }
        ifelse(l < 59,axis(side=2, labels=T,tick=T,las=1),axis(side=2, labels=F,tick=T,las=1))
        axis(side=1, labels=F,tick=T)
        text(-7,20,j,cex=2,font=2)
        text(-0.1,95,letters[alet],font=2)
}
# ovc.data.individuals <- ovc.data.individuals[-10,]
# # a first pass at statistical differences between pops
# t.res <- matrix(NA,ncol=4,nrow=50)
# t.res <- as.data.frame(t.res)
# pops <- unique(hopland.stem[,4])
# d <- 0
# for (i in c(pops)){
#         for (j in c(pops[-(which(pops == i))])){
#                 d <- d + 1
#                 x <- ovc.data.individuals[ovc.data.individuals[,4] == i & ovc.data.individuals[,3] == "H",6]
#                 w <- ovc.data.individuals[ovc.data.individuals[,4] == i & ovc.data.individuals[,3] == "H",7]
#                 y <- ovc.data.individuals[ovc.data.individuals[,4] == j & ovc.data.individuals[,3] == "H",6]
#                 z <- ovc.data.individuals[ovc.data.individuals[,4] == j & ovc.data.individuals[,3] == "H",7]
#                 t.res[d,1] <- i
#                 t.res[d,2] <- j
#                 res <- t.test(x,y)
#                 t.res[d,3] <- as.numeric((res)[3])
#                 res <- t.test(w,z)
#                 t.res[d,4] <- as.numeric((res)[3])
#         }
# }
# Wild pops
# Leaves
col.inds <- c("blue","red","black","blue","violet","pink","brown","yellow","orange")
wild.leaf <- all.ovc.leaf[all.ovc.leaf$site == "Wild",]
tags <- unique(wild.leaf[,3])
# pops <- unique(wild.leaf[,4])
inds.pop <- 1:length(pops)

for (j in c(pops)){
        alet <- alet+1
        k <- 0
        par(new=F)
        # Find the unique individuals of each pop
        for (i in c(unique(wild.leaf[wild.leaf$newpopnumber == j,5]))){
                l <- l + 1
                k <- k + 1
                cols <- sample("blue",1500,TRUE)
                plot(wild.leaf$lwp_MPa[wild.leaf$newpopnumber == j & wild.leaf$individual == i],wild.leaf$percentembolism_.[wild.leaf$newpopnumber == j & wild.leaf$individual == i],col=addTrans(cols,80),yaxt="n",xlim=c(-8,0),ylim=c(0,100),ylab="",xlab="",xaxt="n",type="p",axes=F)
                x.1 <- wild.leaf$lwp_MPa[wild.leaf$newpopnumber == j & wild.leaf$individual == i]
                y.1 <- wild.leaf$percentembolism_.[wild.leaf$newpopnumber == j & wild.leaf$individual == i]
                b.val <- ifelse(j == 3 & k == 2,-5,-4)
                a.val <- ifelse(j == 3 & k == 2, -8,-6)
                plcmod_qd <- nls(y.1~100-100/(1+exp(a*(x.1-b))), start=list(a=a.val,b=b.val))
                xv.1 <- seq(from=-10,to=0,by=0.01)
                yv.1 <- predict(plcmod_qd,data.frame(x.1=xv.1))
                lines(xv.1,yv.1,col="black",lty=2)
                ovc.data.individuals[l,1] <- as.character(unique(wild.leaf$genus[wild.leaf$newpopnumber == j & wild.leaf$individual == i] ))
                ovc.data.individuals[l,2] <- as.character(unique(wild.leaf$species[wild.leaf$newpopnumber == j & wild.leaf$individual == i] ))
                ovc.data.individuals[l,3] <- "W"
                ovc.data.individuals[l,4] <- unique(wild.leaf$newpopnumber[wild.leaf$newpopnumber == j & wild.leaf$individual == i] )
                ovc.data.individuals[l,5] <- unique(wild.leaf$individual[wild.leaf$newpopnumber == j & wild.leaf$individual == i] )
                ovc.data.individuals[l,6] <- max(x.1[which(y.1 == min(y.1[y.1>5],na.rm=T))],na.rm=T)
                ### P12
                a <- coefficients(summary(plcmod_qd))[1]
                p50 <- coefficients(summary(plcmod_qd))[2]
                slope <- -100*a/4
                c <- (100/2) - slope*p50
                p88 <- -c/slope
                p12 <- (100-c)/slope
                ovc.data.individuals[l,7] <- p12
                # P50
                ovc.data.individuals[l,8] <- p50
                ### P88
                ovc.data.individuals[l,9] <- p88
                ovc.data.individuals[l,10] <- as.character(unique(wild.leaf$tissue[wild.leaf$newpopnumber == j & wild.leaf$individual == i] ))
                par(new=T)
        }
        ifelse(l < 93,axis(side=2, labels=T,tick=T,las=1),axis(side=2, labels=F,tick=T,las=1))
        axis(side=1, labels=T,tick=T)
        text(-7,20,j,cex=2,font=2)
        text(-0.1,95,letters[alet],font=2)
}

mtext(side=1,outer=T, line=2, "Water Potential (MPa)", at=0.5)
mtext(expression(paste("Percent Embolism (% Observed)")), side=2,outer=T, line=2, at=0.5)
dev.off()

#############################################################
### 1B Vulnerability to embolism of different populations ###
############### Descriptive statistics ######################
#############################################################
########## Including Coefficient of variation ###############
############# and range for various groups ##################
#############################################################
#############################################################
means.pops <- tapply(ovc.data.individuals$p50,list(ovc.data.individuals$tissue, ovc.data.individuals$pop,ovc.data.individuals$site),mean)
means.se.pops <- tapply(ovc.data.individuals$p50,list(ovc.data.individuals$tissue, ovc.data.individuals$pop,ovc.data.individuals$site),se)

# sample size of populations
(ss.pops <- tapply(ovc.data.individuals$p50,list(ovc.data.individuals$tissue, ovc.data.individuals$pop,ovc.data.individuals$site),length))
# co-efficient of variation within each population
(cv.pops <- tapply(ovc.data.individuals$p50,list(ovc.data.individuals$tissue, ovc.data.individuals$pop,ovc.data.individuals$site),cv))
# coefficient of variation between populations

cv(means.pops[1,,1])
cv(means.pops[2,,1])
cv(means.pops[1,,2])
cv(means.pops[2,,2])
range(means.pops[1,,1])
range(means.pops[2,,1])
range(means.pops[1,,2])
range(means.pops[2,,2])
# Garden 
# leaf
(max.diff <- range(means.pops[1,,1])[1] - range(means.pops[1,,1])[2])
# Stem
(max.diff <- range(means.pops[2,,1])[1] - range(means.pops[2,,1])[2])
# Wild
# leaf
(max.diff <- range(means.pops[1,,2])[1] - range(means.pops[1,,2])[2])
# Stem
(max.diff <- range(means.pops[2,,2])[1] - range(means.pops[2,,2])[2])

range(ovc.data.individuals[ovc.data.individuals$tissue == "leaf",8], na.rm=T)
range(ovc.data.individuals[ovc.data.individuals$tissue == "stem",8], na.rm=T)

# Finding the range within each population for leaves and stems
range.all <- matrix(NA, nrow=28, ncol=9)
range.all <- as.data.frame(range.all)
range.all[,1] <- as.character(range.all[,1])
range.all[,2] <- as.character(range.all[,2])
range.all[,3] <- as.character(range.all[,3])

range.all[,4] <- as.numeric(range.all[,4])
range.all[,5] <- as.numeric(range.all[,5])
range.all[,6] <- as.numeric(range.all[,6])
range.all[,7] <- as.numeric(range.all[,7])
range.all[,8] <- as.numeric(range.all[,8])
range.all[,9] <- as.numeric(range.all[,9])
r.l <- ovc.data.individuals[ovc.data.individuals$tissue == "leaf",]
r.s <- ovc.data.individuals[ovc.data.individuals$tissue == "stem",]
site <- c("H","W")
tissue <- c("stem","leaf")

for (i in c(1:7)){
  range.all[c(i,i+7,i+14,i+21),1] <- pops[i]
  range.all[c(i,i+14),2] <- site[1]
  range.all[c(i+7,i+21),2] <- site[2]
  range.all[c(i,i+7),3] <- tissue[2]
  range.all[c(i+14,i+21),3] <- tissue[1]
  
  range.all[i,4] <- min(r.l[r.l[,3] == site[1] & r.l[,4] == pops[i],7])
  range.all[i,5] <- max(r.l[r.l[,3] == site[1] & r.l[,4] == pops[i],7])
  
  range.all[(i+7),4] <- min(r.l[r.l[,3] == site[2] & r.l[,4] == pops[i],7])
  range.all[(i+7),5] <- max(r.l[r.l[,3] == site[2] & r.l[,4] == pops[i],7])
  
  range.all[i,6] <- min(r.l[r.l[,3] == site[1] & r.l[,4] == pops[i],8])
  range.all[i,7] <- max(r.l[r.l[,3] == site[1] & r.l[,4] == pops[i],8])
  
  range.all[(i+7),6] <- min(r.l[r.l[,3] == site[2] & r.l[,4] == pops[i],8])
  range.all[(i+7),7] <- max(r.l[r.l[,3] == site[2] & r.l[,4] == pops[i],8])
  
  range.all[i,8] <- min(r.l[r.l[,3] == site[1] & r.l[,4] == pops[i],9])
  range.all[i,9] <- max(r.l[r.l[,3] == site[1] & r.l[,4] == pops[i],9])
  
  range.all[(i+7),8] <- min(r.l[r.l[,3] == site[2] & r.l[,4] == pops[i],9])
  range.all[(i+7),9] <- max(r.l[r.l[,3] == site[2] & r.l[,4] == pops[i],9])
  
  range.all[c(i+14),4] <- min(r.s[r.s[,3] == site[1] & r.s[,4] == pops[i],7])
  range.all[c(i+14),5] <- max(r.s[r.s[,3] == site[1] & r.s[,4] == pops[i],7])
  
  range.all[c(i+21),4] <- min(r.s[r.s[,3] == site[2] & r.s[,4] == pops[i],7])
  range.all[c(i+21),5] <- max(r.s[r.s[,3] == site[2] & r.s[,4] == pops[i],7])
  
  range.all[c(i+14),6] <- min(r.s[r.s[,3] == site[1] & r.s[,4] == pops[i],8])
  range.all[c(i+14),7] <- max(r.s[r.s[,3] == site[1] & r.s[,4] == pops[i],8])
  
  range.all[c(i+21),6] <- min(r.s[r.s[,3] == site[2] & r.s[,4] == pops[i],8])
  range.all[c(i+21),7] <- max(r.s[r.s[,3] == site[2] & r.s[,4] == pops[i],8])
  
  range.all[c(i+14),8] <- min(r.s[r.s[,3] == site[1] & r.s[,4] == pops[i],9])
  range.all[c(i+14),9] <- max(r.s[r.s[,3] == site[1] & r.s[,4] == pops[i],9])
  
  range.all[c(i+21),8] <- min(r.s[r.s[,3] == site[2] & r.s[,4] == pops[i],9])
  range.all[c(i+21),9] <- max(r.s[r.s[,3] == site[2] & r.s[,4] == pops[i],9])
}
range.all
range.mag <- matrix(NA,ncol=6,nrow=28)
range.mag <- as.data.frame(range.mag)
range.mag[,1] <- as.character(range.mag[,1])
range.mag[,2] <- as.character(range.mag[,2])
range.mag[,3] <- as.character(range.mag[,3])

range.mag[,4] <- as.numeric(range.mag[,4])
range.mag[,5] <- as.numeric(range.mag[,5])
range.mag[,6] <- as.numeric(range.mag[,6])
range.mag[,1] <- range.all[,1]
range.mag[,2] <- range.all[,2]
range.mag[,3] <- range.all[,3]
range.mag[,4] <- range.all[,5] - range.all[,4]
range.mag[,5] <- range.all[,7] - range.all[,6]
range.mag[,6] <- range.all[,9] - range.all[,8]

range.mag.summary <- matrix(NA, ncol=8, nrow=4)
range.mag.summary <- as.data.frame(range.mag.summary)
(mean.max.range.pe <- tapply(range.mag[,4],list(range.mag[,3],range.mag[,2]),mean, na.rm=T))
(mean.max.range.p50 <- tapply(range.mag[,5],list(range.mag[,3],range.mag[,2]),mean, na.rm=T))
(mean.max.range.p88 <- tapply(range.mag[,6],list(range.mag[,3],range.mag[,2]),mean, na.rm=T))

(mean.max.range.se.pe <- tapply(range.mag[,4],list(range.mag[,3],range.mag[,2]),se))
(mean.max.range.se.p50 <- tapply(range.mag[,5],list(range.mag[,3],range.mag[,2]),se))
(mean.max.range.se.p88 <- tapply(range.mag[,6],list(range.mag[,3],range.mag[,2]),se))

range.all

cv.data <- matrix(NA, ncol=4,nrow=14)
cv.data <- as.data.frame(cv.data)
colnames(cv.data) <- c("site" ,"pop", "cv_leaf","cv_stem")
pe.garden <- ovc.data.individuals[ovc.data.individuals$site == "H",]
pe.wild <- ovc.data.individuals[ovc.data.individuals$site == "W",]
for (i in c(1:7)){
  cv.data[i,3] <- cv(pe.garden[pe.garden$tissue == "leaf" & pe.garden$pop == pops[i],8])
  cv.data[i,4] <- cv(pe.garden[pe.garden$tissue == "stem" & pe.garden$pop == pops[i],8])
  cv.data[i,2] <- pops[i]
  cv.data[i,1] <- "H"
  cv.data[(i+7),3] <- cv(pe.wild[pe.wild$tissue == "leaf" & pe.wild$pop == pops[i],8])
  cv.data[(i+7),4] <- cv(pe.wild[pe.wild$tissue == "stem" & pe.wild$pop == pops[i],8])
  cv.data[(i+7),2] <- pops[i]
  cv.data[(i+7),1] <- "W"
}
cv.data
# coefficient of variation among populations
# sorted by site (H v W) 
# mean stems
tapply(cv.data[,4],cv.data[,1],mean, na.rm=T)
tapply(cv.data[,4],cv.data[,1],se)
# mean leaves
tapply(cv.data[,3],cv.data[,1],mean, na.rm=T)
tapply(cv.data[,3],cv.data[,1],se)

# CV of each pop
# mean stems
pops.cv.stems <- tapply(cv.data[,4],cv.data[,2],mean, na.rm=T)
# mean leaves
pops.cv.leaves <- tapply(cv.data[,3],cv.data[,2],mean, na.rm=T)
# Overall
# stems
mean(pops.cv.stems)
se(pops.cv.stems)
# leaves
mean(pops.cv.leaves)
se(pops.cv.leaves)

t.test(pops.cv.leaves,pops.cv.stems)

cv.leaves <- mean(cv.data[,3], na.rm=T)
cv.stems <- mean(cv.data[,4], na.rm=T)
cv.all <- cv(ovc.data.individuals[,8])
cv.leafp50quercus <- 25.69
cv.stemp50quercus <- 27.35

cv.leaves/cv.leafp50quercus*100
cv.stems/cv.stemp50quercus*100
cv(ovc.data.individuals[ovc.data.individuals$tissue == "leaf" & ovc.data.individuals$site == "H",8])
cv(ovc.data.individuals[ovc.data.individuals$tissue == "leaf" & ovc.data.individuals$site == "W",8])
cv(ovc.data.individuals[ovc.data.individuals$tissue == "stem" & ovc.data.individuals$site == "H",8])
cv(ovc.data.individuals[ovc.data.individuals$tissue == "stem" & ovc.data.individuals$site == "W",8])

#################################################################################################
# Component 1C: Conduct a statistical analysis to assess whether tissues, sites, and populations #
######################### vary in vulnerability to embolism #####################################
#################################################################################################
# plot.design(p50~pop*site*tissue,data=ovc.data.individuals)
op <- par(mfrow = c(3, 1))
with(ovc.data.individuals, {
        interaction.plot(pop,site, p50)
        interaction.plot(pop, tissue, p50)
        interaction.plot(site, tissue, p50)
}
)
par(op)

######################################
######## added 18 April 2019 #########
######## Test for normality ##########
######################################
head(ovc.data.individuals)
par(mfrow=c(1,1))
hist(ovc.data.individuals$p50)
qqnorm(ovc.data.individuals$p50)
qqline(ovc.data.individuals$p50)

# different populations
par(mfrow=c(1,7))
for (i in c(1:7)){
  hist(ovc.data.individuals$p50[ovc.data.individuals$pop==i], xlim=c(-6,-2),col=i)
  result <- shapiro.test(ovc.data.individuals$p50[ovc.data.individuals$pop==i])
  print(result)
}
par(mfrow=c(1,2))
# different sites
for (i in c(1:2)){
  hist(ovc.data.individuals$p50[ovc.data.individuals$site==site[i]], xlim=c(-6,-2),col=i)
  result <- shapiro.test(ovc.data.individuals$p50[ovc.data.individuals$site==site[i]])
  print(result)
}
#tissue
par(mfrow=c(1,2))
for (i in c(1:2)){
  hist(ovc.data.individuals$p50[ovc.data.individuals$tissue==tissue[i]], xlim=c(-6,-2),col=i)
  result <- shapiro.test(ovc.data.individuals$p50[ovc.data.individuals$tissue==tissue[i]])
  print(result)
}
# One of the assumptions of the three way anova is that all of the combinations of factors are normally distributed
tiff(filename = "FigS stats1.tif",
     width = 18, height = 12, units = "cm", pointsize = 8,
     compression = c("lzw"),
     bg = "white", res = 1200, family = "", restoreConsole = TRUE,
     type = c("windows", "cairo"),antialias = "cleartype")
# tissue x pop
# different populations
cols=c("blue","purple","brown","orange","red","grey","cornflowerblue")
par(mfrow=c(2,7))
for (j in c(1:2)){
  for (i in c(1:7)){
    hist(ovc.data.individuals$p50[ovc.data.individuals$pop==i & ovc.data.individuals$tissue==tissue[j]], xlim=c(-7,0),col=cols[i])
    result <- shapiro.test(ovc.data.individuals$p50[ovc.data.individuals$pop==i & ovc.data.individuals$tissue==tissue[j]])
    print(result)
    qqnorm(ovc.data.individuals$p50[ovc.data.individuals$pop==i & ovc.data.individuals$tissue==tissue[j]])
    qqline(ovc.data.individuals$p50[ovc.data.individuals$pop==i & ovc.data.individuals$tissue==tissue[j]])
    }
}
dev.off()
tiff(filename = "FigS stats2.tif",
     width = 18, height = 12, units = "cm", pointsize = 8,
     compression = c("lzw"),
     bg = "white", res = 1200, family = "", restoreConsole = TRUE,
     type = c("windows", "cairo"),antialias = "cleartype")
# site x tissue
par(mfrow=c(2,2))
for (j in c(1:2)){
  for (i in c(1:2)){
    hist(ovc.data.individuals$p50[ovc.data.individuals$site==site[i]& ovc.data.individuals$tissue==tissue[j]], xlim=c(-7,0),col=i)
    result <- shapiro.test(ovc.data.individuals$p50[ovc.data.individuals$site==site[i]& ovc.data.individuals$tissue==tissue[j]])
    print(result)
    qqnorm(ovc.data.individuals$p50[ovc.data.individuals$site==site[i]& ovc.data.individuals$tissue==tissue[j]])
    qqline(ovc.data.individuals$p50[ovc.data.individuals$site==site[i]& ovc.data.individuals$tissue==tissue[j]])
  }
}
dev.off()
tiff(filename = "FigS stats3.tif",
     width = 18, height = 12, units = "cm", pointsize = 8,
     compression = c("lzw"),
     bg = "white", res = 1200, family = "", restoreConsole = TRUE,
     type = c("windows", "cairo"),antialias = "cleartype")
# site x pop
par(mfrow=c(2,7))
for (i in c(1:2)){
  for (j in c(1:7)){
    hist(ovc.data.individuals$p50[ovc.data.individuals$site==site[i] & ovc.data.individuals$pop==j], xlim=c(-7,0),col=i)
    result <- shapiro.test(ovc.data.individuals$p50[ovc.data.individuals$site==site[i]& ovc.data.individuals$pop==j])
    print(result)
    qqnorm(ovc.data.individuals$p50[ovc.data.individuals$site==site[i] & ovc.data.individuals$pop==j])
    qqline(ovc.data.individuals$p50[ovc.data.individuals$site==site[i] & ovc.data.individuals$pop==j])
  }
}
dev.off()
##################################
############# ANOVA ##############
##################################
# Tissue and Site are Fixed factors
# Population is a random factor

# Testing for differences in p50 between populations
str(ovc.data.individuals)
ovc.data.individuals[,4] <- as.factor(ovc.data.individuals[,4])
ovc.data.individuals[,3] <- as.factor(ovc.data.individuals[,3])
ovc.data.individuals[,10] <- as.factor(ovc.data.individuals[,10])
names(ovc.data.individuals)
an.mod <- aov(p50~tissue*site*pop,data=ovc.data.individuals)
an.mod <- aov(p50~tissue+site+pop + tissue*site*pop,data=ovc.data.individuals)
# Start with Type III (to examine whether there are interactions between pops and sites)
f.mod <- Anova(lm(p50~tissue*site*pop,data=ovc.data.individuals, contrasts=list(topic=contr.sum, sys=contr.sum)), type=3)

summary(an.mod)
f.mod
ss.mod <- f.mod$`Sum Sq`[2:9]
prop.v <- matrix(NA, nrow=8, ncol=2)
prop.v <- as.data.frame(prop.v)
prop.v[,1] <- as.character(prop.v[,1])
prop.v[,2] <- as.numeric(prop.v[,2])
prop.v[,1] <- row.names(f.mod)[2:9]
for (i in c(1:8)){
    prop.v[i,2] <- ss.mod[i]/sum(ss.mod)*100    
}
round(prop.v[,2],2)
prop.v

# Post hoc tests
model<-lm(p50~tissue*site*pop,data=ovc.data.individuals)
comparison <- HSD.test(model,"tissue", group=TRUE,main="p50", console=T)
comparison <- HSD.test(model,"site", group=TRUE,main="p50", console=T)

TukeyHSD(an.mod, "tissue")
# TukeyHSD(an.mod, "site")
# TukeyHSD(an.mod, "pop")

# ANOVA on separate leaf and stem databases
# Start with stems
pe.ind.stems <- matrix(NA, ncol=ncol(ovc.data.individuals),nrow=length(ovc.data.individuals$tissue == "stem"))
pe.ind.stems <- as.data.frame(pe.ind.stems)
pe.ind.stems <- ovc.data.individuals[ovc.data.individuals$tissue == "stem",]
an.mod <- aov(p50~pop*site,data=pe.ind.stems)
summary(an.mod)
f.mod <- Anova(an.mod, type="III")
f.mod

ss.mod <- f.mod$`Sum Sq`[2:5]
prop.v <- matrix(NA, nrow=4, ncol=2)
prop.v <- as.data.frame(prop.v)
prop.v[,1] <- as.character(prop.v[,1])
prop.v[,2] <- as.numeric(prop.v[,2])
prop.v[,1] <- row.names(f.mod)[2:5]
for (i in c(1:4)){
  prop.v[i,2] <- ss.mod[i]/sum(ss.mod)*100    
}
round(prop.v[,2],2)
prop.v

# Post hoc tests
model<-lm(p50~site*pop,data=pe.ind.stems)
comparison <- HSD.test(model,"site", group=TRUE,main="p50", console=T)
comparison <- HSD.test(model,"pop", group=TRUE,main="p50", console=T)

TukeyHSD(an.mod, "site")
TukeyHSD(an.mod, "pop")

# Leaves
pe.ind.leaves <- matrix(NA, ncol=ncol(ovc.data.individuals),nrow=length(ovc.data.individuals$tissue == "leaf"))
pe.ind.leaves <- as.data.frame(pe.ind.leaves)
pe.ind.leaves <- ovc.data.individuals[ovc.data.individuals$tissue == "leaf",]
an.mod <- aov(p50~site*pop,data=pe.ind.leaves)
str(pe.ind.leaves)
f.mod <- Anova(an.mod, type="III")
summary(an.mod)
ss.mod <- f.mod$`Sum Sq`[2:5]
prop.v <- matrix(NA, nrow=4, ncol=2)
prop.v <- as.data.frame(prop.v)
prop.v[,1] <- as.character(prop.v[,1])
prop.v[,2] <- as.numeric(prop.v[,2])
prop.v[,1] <- row.names(f.mod)[2:5]
for (i in c(1:4)){
  prop.v[i,2] <- ss.mod[i]/sum(ss.mod)*100    
}
round(prop.v[,2],2)
prop.v
f.mod
# Post hoc tests
model<-lm(p50~site*pop,data=pe.ind.leaves)
comparison <- HSD.test(model,"site", group=TRUE,main="p50", console=T)
comparison <- HSD.test(model,"pop", group=TRUE,main="p50", console=T)

TukeyHSD(an.mod, "site")
TukeyHSD(an.mod, "pop")


############################################################################
#### Component 1D: Generate a Figure showing population mean P50 values ####
############################################################################
tiff(filename = "FigX P50 Pop means.tif",
     width = 8, height = 14, units = "cm", pointsize = 8,
     compression = c("lzw"),
     bg = "white", res = 1200, family = "", restoreConsole = TRUE,
     type = c("windows", "cairo"),antialias = "cleartype")
# boxplot for p50 values across different populations and sites
par(mfrow=c(2,1),oma=c(4,4,0.4,0.4),mar=c(0.55,0.1,0.1,0.1))
dt <- p50~pop*site
boxplot(dt, ylim=c(-6,0),axes=F,las=1,data=ovc.data.individuals[ovc.data.individuals$tissue == "leaf",],col=c("blue","purple","brown","orange","red","grey","cornflowerblue"),frame.plot=TRUE)
x.lab <- c(rep(sort(pops),2))
axis(1,at=seq(1,14,1),labels=F,tick=T,cex.axis=0.7)
axis(side=2,labels=T,tick=T,las=1)
xv <- seq(from=1,to=7, by=1)
yv <- rep(-2,7)
lines(yv~xv, col="black",lty=1,lwd=2)
text(4,-1.5,"Common Garden")
xv <- seq(from=8,to=14, by=1)
yv <- rep(-2,7)
lines(yv~xv, col="black",lty=1,lwd=2)
text(11,-1.5,"Wild populations")
text(7,-0.5,"Leaves")
text(1,-0.1,"a", font=2)
# abline(h = -3.790243, lty=2, col="black")
# abline(h = -3.790243+0.08066, lty=3, col="black")
# abline(h = -3.790243-0.08066, lty=3, col="black")
dt <- p50~pop*site
boxplot(dt, ylim=c(-6,0),axes=F,las=1,data=ovc.data.individuals[ovc.data.individuals$tissue == "stem",],col=c("blue","purple","brown","orange","red","grey","cornflowerblue"),frame.plot=TRUE)
x.lab <- c(rep(sort(pops),2))
axis(1,at=seq(1,14,1),labels=x.lab,cex.axis=0.7)
axis(side=2,labels=T,tick=T,las=1)
xv <- seq(from=1,to=7, by=1)
yv <- rep(-2,7)
lines(yv~xv, col="black",lty=1,lwd=2)
text(4,-1.5,"Common Garden")
xv <- seq(from=8,to=14, by=1)
yv <- rep(-2,7)
lines(yv~xv, col="black",lty=1,lwd=2)
text(11,-1.5,"Wild populations")
text(7,-0.5,"Stems")
text(1,-0.1,"b", font=2)
# abline(h = -4.3285, lty=2, col="black")
# abline(h = -4.3285+0.098764, lty=3, col="black")
# abline(h = -4.3285-0.098764, lty=3, col="black")
mtext("Population", side=1,outer=T, line=2, at=0.5)
mtext(expression(paste(P[50], " (MPa)")), side=2,outer=T, line=2, at=0.5)
dev.off()
getwd()
# # Investigating population differences
# # Leaves Wild populations
# x.l <- ovc.data.individuals[ovc.data.individuals$tissue == "leaf",]
# x.l <- x.l[!is.na(x.l[,1]),]
# x.l.wild <- x.l[x.l$site == "W",] 
# data <- matrix(NA, nrow=nrow(x.l.wild),ncol=2)
# data <- as.data.frame(data)
# data[,1] <- as.factor(data[,1])
# data[,2] <- as.numeric(data[,2])
# #
# data[,1] <- as.vector(x.l.wild[,4])
# names(x.l.wild)
# data[,2] <- as.vector(x.l.wild[,8])
# str(data)
# a.wild <- aov(data[,2]~as.factor(data[,1]))
# Anova(a.wild, type="III")
# summary(a.wild)
# boxplot(data[,2]~as.factor(data[,1]))
# TukeyHSD(aov(data[,2]~as.factor(data[,1])))
# # Leaves common garden 
# x.l <- ovc.data.individuals[ovc.data.individuals$tissue == "leaf",]
# x.l <- x.l[!is.na(x.l[,1]),]
# x.l.wild <- x.l[x.l$site == "H",] 
# data <- matrix(NA, nrow=nrow(x.l.wild),ncol=2)
# data <- as.data.frame(data)
# data[,1] <- as.factor(data[,1])
# data[,2] <- as.numeric(data[,2])
# #
# data[,1] <- as.vector(x.l.wild[,4])
# data[,2] <- as.vector(x.l.wild[,8])
# str(data)
# a.wild <- aov(data[,2]~as.factor(data[,1]))
# Anova(a.wild, type="III")
# summary(a.wild)
# boxplot(data[,2]~as.factor(data[,1]))
# TukeyHSD(aov(data[,2]~as.factor(data[,1])))
# 
# # Stems Wild pops
# x <- ovc.data.individuals[ovc.data.individuals$tissue == "stem",]
# x <- x[!is.na(x[,1]),]
# x.wild <- x[x$site == "W",] 
# data <- matrix(NA, nrow=nrow(x.wild),ncol=2)
# data <- as.data.frame(data)
# data[,1] <- as.factor(data[,1])
# data[,2] <- as.numeric(data[,2])
# #
# data[,1] <- as.vector(x.wild[,4])
# data[,2] <- as.vector(x.wild[,8])
# str(data)
# a.wild <- aov(data[,2]~as.factor(data[,1]))
# summary(a.wild)
# Anova(a.wild, type="III")
# boxplot(data[,2]~as.factor(data[,1]))
# TukeyHSD(aov(data[,2]~as.factor(data[,1])))
# # Stems garden pops
# x <- ovc.data.individuals[ovc.data.individuals$tissue == "stem",]
# x <- x[!is.na(x[,1]),]
# x.wild <- x[x$site == "H",] 
# data <- matrix(NA, nrow=nrow(x.wild),ncol=2)
# data <- as.data.frame(data)
# data[,1] <- as.factor(data[,1])
# data[,2] <- as.numeric(data[,2])
# #
# data[,1] <- as.vector(x.wild[,4])
# data[,2] <- as.vector(x.wild[,8])
# str(data)
# a.wild <- aov(data[,2]~as.factor(data[,1]))
# Anova(a.wild, type="III")
# summary(a.wild)
# boxplot(data[,2]~as.factor(data[,1]))
# TukeyHSD(aov(data[,2]~as.factor(data[,1])))
# 
# # what about just in the garden?
# names(pe.ind.stems)
# pe.i.s.g <- pe.ind.stems[pe.ind.stems$site == "H",]
# an.mod <- aov(p50~pop,data=pe.i.s.g)
# f.mod <- Anova(an.mod, type="III")
# summary(an.mod)
# f.mod
# TukeyHSD(an.mod, "pop")
# 
# names(pe.ind.stems)
# pe.i.s.w <- pe.ind.stems[pe.ind.stems$site == "W",]
# an.mod <- aov(p50~pop,data=pe.i.s.w)
# f.mod <- Anova(an.mod, type="III")
# summary(an.mod)
# f.mod
# TukeyHSD(an.mod, "pop")
# 
# pe.i.l.g <- pe.ind.leaves[pe.ind.leaves$site == "H",]
# an.mod <- aov(p50~pop,data=pe.i.l.g)
# f.mod <- Anova(an.mod, type="III")
# summary(an.mod)
# f.mod
# TukeyHSD(an.mod, "pop")
# 
# pe.i.l.w <- pe.ind.leaves[pe.ind.leaves$site == "W",]
# an.mod <- aov(p50~pop,data=pe.i.l.w)
# f.mod <- Anova(an.mod, type="III")
# summary(an.mod)
# f.mod
# TukeyHSD(an.mod, "pop")
##########################
### end stats for P50 ####
##########################

# calculate means and standard error values for each pop
(p50.means <- tapply(ovc.data.individuals[,8],list(ovc.data.individuals[,3],ovc.data.individuals[,4],ovc.data.individuals[,10]),mean,na.rm=T))
p50.means.se <- tapply(ovc.data.individuals[,8],list(ovc.data.individuals[,3],ovc.data.individuals[,4],ovc.data.individuals[,10]),se)
pops.labs <- tapply(ovc.data.individuals[,4],list(ovc.data.individuals[,3],ovc.data.individuals[,4],ovc.data.individuals[,10]),mean,na.rm=T)


#################################################################################################
# Component 1E: Conduct a statistical analysis to assess whether tissues, sites, and populations #
######################### vary in vulnerability to embolism #####################################
#################################################################################################
# plot.design(p50~pop*site*tissue,data=ovc.data.individuals)
# p12
op <- par(mfrow = c(3, 1))
with(ovc.data.individuals, {
  interaction.plot(pop,site, p12)
  interaction.plot(pop, tissue, p12)
  interaction.plot(site, tissue, p12)
}
)
par(op)

##########################################
############# ANOVA for P12 ##############
##########################################
# Tissue and Site are Fixed factors
# Population is a random factor

# Testing for differences in p12 between populations
str(ovc.data.individuals)
ovc.data.individuals[,4] <- as.factor(ovc.data.individuals[,4])
ovc.data.individuals[,3] <- as.factor(ovc.data.individuals[,3])
ovc.data.individuals[,10] <- as.factor(ovc.data.individuals[,10])
an.mod <- aov(p12~tissue*site*pop,data=ovc.data.individuals)
# Start with Type III (to examine whether there are interactions between pops and sites)
f.mod1 <- Anova(lm(p12~tissue*site*pop,data=ovc.data.individuals, contrasts=list(topic=contr.sum, sys=contr.sum)), type=3)
# use type II because there are no interactions
f.mod2 <- Anova(lm(p12~tissue+ site +pop,data=ovc.data.individuals, contrasts=list(topic=contr.sum, sys=contr.sum)), type=2)

f.mod <- Anova(an.mod, type="III")
f.mod
f.mod1
ss.mod <- f.mod$`Sum Sq`[2:9]
prop.v <- matrix(NA, nrow=8, ncol=2)
prop.v <- as.data.frame(prop.v)
prop.v[,1] <- as.character(prop.v[,1])
prop.v[,2] <- as.numeric(prop.v[,2])
prop.v[,1] <- row.names(f.mod)[2:9]
for (i in c(1:8)){
  prop.v[i,2] <- ss.mod[i]/sum(ss.mod)*100    
}
round(prop.v[,2],2)
prop.v

# Post hoc tests
TukeyHSD(an.mod, "tissue")
TukeyHSD(an.mod, "site")
TukeyHSD(an.mod, "pop")

# ANOVA on separate leaf and stem databases
# Start with stems
pe.ind.stems <- matrix(NA, ncol=ncol(ovc.data.individuals),nrow=length(ovc.data.individuals$tissue == "stem"))
pe.ind.stems <- as.data.frame(pe.ind.stems)
pe.ind.stems <- ovc.data.individuals[ovc.data.individuals$tissue == "stem",]
an.mod <- aov(p12~site*pop,data=pe.ind.stems)
f.mod <- Anova(an.mod, type="III")
summary(an.mod)
f.mod
ss.mod <- f.mod$`Sum Sq`[2:5]
prop.v <- matrix(NA, nrow=4, ncol=2)
prop.v <- as.data.frame(prop.v)
prop.v[,1] <- as.character(prop.v[,1])
prop.v[,2] <- as.numeric(prop.v[,2])
prop.v[,1] <- row.names(f.mod)[2:5]
for (i in c(1:4)){
  prop.v[i,2] <- ss.mod[i]/sum(ss.mod)*100    
}
round(prop.v[,2],2)
prop.v
f.mod
# Post hoc tests
TukeyHSD(an.mod, "site")
TukeyHSD(an.mod, "pop")

# Leaves
pe.ind.leaves <- matrix(NA, ncol=ncol(ovc.data.individuals),nrow=length(ovc.data.individuals$tissue == "leaf"))
pe.ind.leaves <- as.data.frame(pe.ind.leaves)
pe.ind.leaves <- ovc.data.individuals[ovc.data.individuals$tissue == "leaf",]
an.mod <- aov(p12~site*pop,data=pe.ind.leaves)
str(pe.ind.leaves)
f.mod <- Anova(an.mod, type="III")
f.mod
ss.mod <- f.mod$`Sum Sq`[2:5]
prop.v <- matrix(NA, nrow=4, ncol=2)
prop.v <- as.data.frame(prop.v)
prop.v[,1] <- as.character(prop.v[,1])
prop.v[,2] <- as.numeric(prop.v[,2])
prop.v[,1] <- row.names(f.mod)[2:5]
for (i in c(1:4)){
  prop.v[i,2] <- ss.mod[i]/sum(ss.mod)*100    
}
round(prop.v[,2],2)
prop.v
f.mod
# Post hoc tests
TukeyHSD(an.mod, "site")
TukeyHSD(an.mod, "pop")

##############################################################################
### Component 1F: Vulnerability to embolism of different populations - P12 ###
###################### Descriptive statistics ################################
##############################################################################
########## Including Coefficient of variation ##################
############# and range for various groups #####################
################################################################
################################################################

names(ovc.data.individuals)
means.pops <- tapply(ovc.data.individuals$p12,list(ovc.data.individuals$tissue, ovc.data.individuals$pop,ovc.data.individuals$site),mean)
means.se.pops <- tapply(ovc.data.individuals$p12,list(ovc.data.individuals$tissue, ovc.data.individuals$pop,ovc.data.individuals$site),se)
# sample size of populations
ss.pops <- tapply(ovc.data.individuals$p12,list(ovc.data.individuals$tissue, ovc.data.individuals$pop,ovc.data.individuals$site),length)
# co-efficient of variation within each population
cv.pops <- tapply(ovc.data.individuals$p12,list(ovc.data.individuals$tissue, ovc.data.individuals$pop,ovc.data.individuals$site),cv)
# coefficient of variation between populations

cv(means.pops[1,,1])
cv(means.pops[2,,1])
cv(means.pops[1,,2])
cv(means.pops[2,,2])
range(means.pops[1,,1])
range(means.pops[2,,1])
range(means.pops[1,,2])
range(means.pops[2,,2])
# Garden 
# leaf
(max.diff <- range(means.pops[1,,1])[1] - range(means.pops[1,,1])[2])
# Stem
(max.diff <- range(means.pops[2,,1])[1] - range(means.pops[2,,1])[2])
# Wild
# leaf
(max.diff <- range(means.pops[1,,2])[1] - range(means.pops[1,,2])[2])
# Stem
(max.diff <- range(means.pops[2,,2])[1] - range(means.pops[2,,2])[2])

range(ovc.data.individuals[ovc.data.individuals$tissue == "leaf",8], na.rm=T)
range(ovc.data.individuals[ovc.data.individuals$tissue == "stem",8], na.rm=T)

# Finding the range within each population for leaves and stems
range.all <- matrix(NA, nrow=28, ncol=9)
range.all <- as.data.frame(range.all)
range.all[,1] <- as.character(range.all[,1])
range.all[,2] <- as.character(range.all[,2])
range.all[,3] <- as.character(range.all[,3])

range.all[,4] <- as.numeric(range.all[,4])
range.all[,5] <- as.numeric(range.all[,5])
range.all[,6] <- as.numeric(range.all[,6])
range.all[,7] <- as.numeric(range.all[,7])
range.all[,8] <- as.numeric(range.all[,8])
range.all[,9] <- as.numeric(range.all[,9])
r.l <- ovc.data.individuals[ovc.data.individuals$tissue == "leaf",]
r.s <- ovc.data.individuals[ovc.data.individuals$tissue == "stem",]
site <- c("H","W")
tissue <- c("stem","leaf")

for (i in c(1:7)){
  range.all[c(i,i+7,i+14,i+21),1] <- pops[i]
  range.all[c(i,i+14),2] <- site[1]
  range.all[c(i+7,i+21),2] <- site[2]
  range.all[c(i,i+7),3] <- tissue[2]
  range.all[c(i+14,i+21),3] <- tissue[1]
  
  range.all[i,4] <- min(r.l[r.l[,3] == site[1] & r.l[,4] == pops[i],7])
  range.all[i,5] <- max(r.l[r.l[,3] == site[1] & r.l[,4] == pops[i],7])
  
  range.all[(i+7),4] <- min(r.l[r.l[,3] == site[2] & r.l[,4] == pops[i],7])
  range.all[(i+7),5] <- max(r.l[r.l[,3] == site[2] & r.l[,4] == pops[i],7])
  
  range.all[i,6] <- min(r.l[r.l[,3] == site[1] & r.l[,4] == pops[i],8])
  range.all[i,7] <- max(r.l[r.l[,3] == site[1] & r.l[,4] == pops[i],8])
  
  range.all[(i+7),6] <- min(r.l[r.l[,3] == site[2] & r.l[,4] == pops[i],8])
  range.all[(i+7),7] <- max(r.l[r.l[,3] == site[2] & r.l[,4] == pops[i],8])
  
  range.all[i,8] <- min(r.l[r.l[,3] == site[1] & r.l[,4] == pops[i],9])
  range.all[i,9] <- max(r.l[r.l[,3] == site[1] & r.l[,4] == pops[i],9])
  
  range.all[(i+7),8] <- min(r.l[r.l[,3] == site[2] & r.l[,4] == pops[i],9])
  range.all[(i+7),9] <- max(r.l[r.l[,3] == site[2] & r.l[,4] == pops[i],9])
  
  range.all[c(i+14),4] <- min(r.s[r.s[,3] == site[1] & r.s[,4] == pops[i],7])
  range.all[c(i+14),5] <- max(r.s[r.s[,3] == site[1] & r.s[,4] == pops[i],7])
  
  range.all[c(i+21),4] <- min(r.s[r.s[,3] == site[2] & r.s[,4] == pops[i],7])
  range.all[c(i+21),5] <- max(r.s[r.s[,3] == site[2] & r.s[,4] == pops[i],7])
  
  range.all[c(i+14),6] <- min(r.s[r.s[,3] == site[1] & r.s[,4] == pops[i],8])
  range.all[c(i+14),7] <- max(r.s[r.s[,3] == site[1] & r.s[,4] == pops[i],8])
  
  range.all[c(i+21),6] <- min(r.s[r.s[,3] == site[2] & r.s[,4] == pops[i],8])
  range.all[c(i+21),7] <- max(r.s[r.s[,3] == site[2] & r.s[,4] == pops[i],8])
  
  range.all[c(i+14),8] <- min(r.s[r.s[,3] == site[1] & r.s[,4] == pops[i],9])
  range.all[c(i+14),9] <- max(r.s[r.s[,3] == site[1] & r.s[,4] == pops[i],9])
  
  range.all[c(i+21),8] <- min(r.s[r.s[,3] == site[2] & r.s[,4] == pops[i],9])
  range.all[c(i+21),9] <- max(r.s[r.s[,3] == site[2] & r.s[,4] == pops[i],9])
}
range.all
range.mag <- matrix(NA,ncol=6,nrow=28)
range.mag <- as.data.frame(range.mag)
range.mag[,1] <- as.character(range.mag[,1])
range.mag[,2] <- as.character(range.mag[,2])
range.mag[,3] <- as.character(range.mag[,3])

range.mag[,4] <- as.numeric(range.mag[,4])
range.mag[,5] <- as.numeric(range.mag[,5])
range.mag[,6] <- as.numeric(range.mag[,6])
range.mag[,1] <- range.all[,1]
range.mag[,2] <- range.all[,2]
range.mag[,3] <- range.all[,3]
range.mag[,4] <- range.all[,5] - range.all[,4]
range.mag[,5] <- range.all[,7] - range.all[,6]
range.mag[,6] <- range.all[,9] - range.all[,8]

range.mag.summary <- matrix(NA, ncol=8, nrow=4)
range.mag.summary <- as.data.frame(range.mag.summary)
(mean.max.range.pe <- tapply(range.mag[,4],list(range.mag[,3],range.mag[,2]),mean, na.rm=T))
(mean.max.range.p12 <- tapply(range.mag[,5],list(range.mag[,3],range.mag[,2]),mean, na.rm=T))
(mean.max.range.p88 <- tapply(range.mag[,6],list(range.mag[,3],range.mag[,2]),mean, na.rm=T))

(mean.max.range.se.pe <- tapply(range.mag[,4],list(range.mag[,3],range.mag[,2]),se))
(mean.max.range.se.p12 <- tapply(range.mag[,5],list(range.mag[,3],range.mag[,2]),se))
(mean.max.range.se.p88 <- tapply(range.mag[,6],list(range.mag[,3],range.mag[,2]),se))

range.all

cv.data <- matrix(NA, ncol=4,nrow=14)
cv.data <- as.data.frame(cv.data)
colnames(cv.data) <- c("site" ,"pop", "cv_leaf","cv_stem")
pe.garden <- ovc.data.individuals[ovc.data.individuals$site == "H",]
pe.wild <- ovc.data.individuals[ovc.data.individuals$site == "W",]
for (i in c(1:7)){
  cv.data[i,3] <- cv(pe.garden[pe.garden$tissue == "leaf" & pe.garden$pop == pops[i],8])
  cv.data[i,4] <- cv(pe.garden[pe.garden$tissue == "stem" & pe.garden$pop == pops[i],8])
  cv.data[i,2] <- pops[i]
  cv.data[i,1] <- "H"
  cv.data[(i+7),3] <- cv(pe.wild[pe.wild$tissue == "leaf" & pe.wild$pop == pops[i],8])
  cv.data[(i+7),4] <- cv(pe.wild[pe.wild$tissue == "stem" & pe.wild$pop == pops[i],8])
  cv.data[(i+7),2] <- pops[i]
  cv.data[(i+7),1] <- "W"
}
cv.data
# coefficient of variation among populations
# sorted by site (H v W) 
# mean stems
tapply(cv.data[,4],cv.data[,1],mean, na.rm=T)
tapply(cv.data[,4],cv.data[,1],se)
# mean leaves
tapply(cv.data[,3],cv.data[,1],mean, na.rm=T)
tapply(cv.data[,3],cv.data[,1],se)

# CV of each pop
# mean stems
pops.cv.stems <- tapply(cv.data[,4],cv.data[,2],mean, na.rm=T)
# mean leaves
pops.cv.leaves <- tapply(cv.data[,3],cv.data[,2],mean, na.rm=T)
# Overall
# stems
mean(pops.cv.stems)
se(pops.cv.stems)
# leaves
mean(pops.cv.leaves)
se(pops.cv.leaves)

t.test(pops.cv.leaves,pops.cv.stems)

cv.leaves <- mean(cv.data[,3], na.rm=T)
cv.stems <- mean(cv.data[,4], na.rm=T)
cv.all <- cv(ovc.data.individuals[,8])
cv.leafp12quercus <- 25.69
cv.stemp12quercus <- 27.35

cv.leaves/cv.leafp12quercus*100
cv.stems/cv.stemp12quercus*100
cv(ovc.data.individuals[ovc.data.individuals$tissue == "leaf" & ovc.data.individuals$site == "H",8])
cv(ovc.data.individuals[ovc.data.individuals$tissue == "leaf" & ovc.data.individuals$site == "W",8])
cv(ovc.data.individuals[ovc.data.individuals$tissue == "stem" & ovc.data.individuals$site == "H",8])
cv(ovc.data.individuals[ovc.data.individuals$tissue == "stem" & ovc.data.individuals$site == "W",8])

##############################################################################
##### Component 1G: Generate a Figure showing population mean p12 values #####
##############################################################################
tiff(filename = "FigX p12 Pop means.tif",
     width = 8, height = 14, units = "cm", pointsize = 8,
     compression = c("lzw"),
     bg = "white", res = 1200, family = "", restoreConsole = TRUE,
     type = c("windows", "cairo"),antialias = "cleartype")
# boxplot for p12 values across different populations and sites
par(mfrow=c(2,1),oma=c(4,4,0.4,0.4),mar=c(0.55,0.1,0.1,0.1))
dt <- p12~pop*site
boxplot(dt, ylim=c(-6,0),axes=F,las=1,data=ovc.data.individuals[ovc.data.individuals$tissue == "leaf",],col=c("blue","purple","brown","orange","red","grey","cornflowerblue"),frame.plot=TRUE)
x.lab <- c(rep(sort(pops),2))
axis(1,at=seq(1,14,1),labels=F,tick=T,cex.axis=0.7)
axis(side=2,labels=T,tick=T,las=1)
xv <- seq(from=1,to=7, by=1)
yv <- rep(-2,7)
lines(yv~xv, col="black",lty=1,lwd=2)
text(4,-1.5,"Common Garden")
xv <- seq(from=8,to=14, by=1)
yv <- rep(-2,7)
lines(yv~xv, col="black",lty=1,lwd=2)
text(11,-1.5,"Wild populations")
text(7,-0.5,"Leaves")
text(1,-0.1,"a", font=2)
# abline(h = -3.790243, lty=2, col="black")
# abline(h = -3.790243+0.08066, lty=3, col="black")
# abline(h = -3.790243-0.08066, lty=3, col="black")
dt <- p12~pop*site
boxplot(dt, ylim=c(-6,0),axes=F,las=1,data=ovc.data.individuals[ovc.data.individuals$tissue == "stem",],col=c("blue","purple","brown","orange","red","grey","cornflowerblue"),frame.plot=TRUE)
x.lab <- c(rep(sort(pops),2))
axis(1,at=seq(1,14,1),labels=x.lab,cex.axis=0.7)
axis(side=2,labels=T,tick=T,las=1)
xv <- seq(from=1,to=7, by=1)
yv <- rep(-2,7)
lines(yv~xv, col="black",lty=1,lwd=2)
text(4,-1.5,"Common Garden")
xv <- seq(from=8,to=14, by=1)
yv <- rep(-2,7)
lines(yv~xv, col="black",lty=1,lwd=2)
text(11,-1.5,"Wild populations")
text(7,-0.5,"Stems")
text(1,-0.1,"b", font=2)
# abline(h = -4.3285, lty=2, col="black")
# abline(h = -4.3285+0.098764, lty=3, col="black")
# abline(h = -4.3285-0.098764, lty=3, col="black")
mtext("Population", side=1,outer=T, line=2, at=0.5)
mtext(expression(paste(P[12], " (MPa)")), side=2,outer=T, line=2, at=0.5)
dev.off()

# Investigating population differences
# Leaves Wild populations
x.l <- ovc.data.individuals[ovc.data.individuals$tissue == "leaf",]
x.l <- x.l[!is.na(x.l[,1]),]
x.l.wild <- x.l[x.l$site == "W",] 
data <- matrix(NA, nrow=nrow(x.l.wild),ncol=2)
data <- as.data.frame(data)
data[,1] <- as.factor(data[,1])
data[,2] <- as.numeric(data[,2])
#
data[,1] <- as.vector(x.l.wild[,4])
names(x.l.wild)
data[,2] <- as.vector(x.l.wild[,8])
str(data)
a.wild <- aov(data[,2]~as.factor(data[,1]))
Anova(a.wild, type="III")
summary(a.wild)
boxplot(data[,2]~as.factor(data[,1]))
TukeyHSD(aov(data[,2]~as.factor(data[,1])))
# Leaves common garden 
x.l <- ovc.data.individuals[ovc.data.individuals$tissue == "leaf",]
x.l <- x.l[!is.na(x.l[,1]),]
x.l.wild <- x.l[x.l$site == "H",] 
data <- matrix(NA, nrow=nrow(x.l.wild),ncol=2)
data <- as.data.frame(data)
data[,1] <- as.factor(data[,1])
data[,2] <- as.numeric(data[,2])
#
data[,1] <- as.vector(x.l.wild[,4])
data[,2] <- as.vector(x.l.wild[,8])
str(data)
a.wild <- aov(data[,2]~as.factor(data[,1]))
Anova(a.wild, type="III")
summary(a.wild)
boxplot(data[,2]~as.factor(data[,1]))
TukeyHSD(aov(data[,2]~as.factor(data[,1])))

# Stems Wild pops
x <- ovc.data.individuals[ovc.data.individuals$tissue == "stem",]
x <- x[!is.na(x[,1]),]
x.wild <- x[x$site == "W",] 
data <- matrix(NA, nrow=nrow(x.wild),ncol=2)
data <- as.data.frame(data)
data[,1] <- as.factor(data[,1])
data[,2] <- as.numeric(data[,2])
#
data[,1] <- as.vector(x.wild[,4])
data[,2] <- as.vector(x.wild[,8])
str(data)
a.wild <- aov(data[,2]~as.factor(data[,1]))
summary(a.wild)
Anova(a.wild, type="III")
boxplot(data[,2]~as.factor(data[,1]))
TukeyHSD(aov(data[,2]~as.factor(data[,1])))
# Stems garden pops
x <- ovc.data.individuals[ovc.data.individuals$tissue == "stem",]
x <- x[!is.na(x[,1]),]
x.wild <- x[x$site == "H",] 
data <- matrix(NA, nrow=nrow(x.wild),ncol=2)
data <- as.data.frame(data)
data[,1] <- as.factor(data[,1])
data[,2] <- as.numeric(data[,2])
#
data[,1] <- as.vector(x.wild[,4])
data[,2] <- as.vector(x.wild[,8])
str(data)
a.wild <- aov(data[,2]~as.factor(data[,1]))
Anova(a.wild, type="III")
summary(a.wild)
boxplot(data[,2]~as.factor(data[,1]))
TukeyHSD(aov(data[,2]~as.factor(data[,1])))

pe.means <- tapply(ovc.data.individuals[,7],list(ovc.data.individuals[,3],ovc.data.individuals[,4],ovc.data.individuals[,10]),mean,na.rm=T)
pe.means.se <- tapply(ovc.data.individuals[,7],list(ovc.data.individuals[,3],ovc.data.individuals[,4],ovc.data.individuals[,10]),se)

#################################################################################################
# Component 1H: Conduct a statistical analysis to assess whether tissues, sites, and populations #
######################### vary in vulnerability to embolism #####################################
#################################################################################################
# plot.design(p50~pop*site*tissue,data=ovc.data.individuals)
# p88
op <- par(mfrow = c(3, 1))
with(ovc.data.individuals, {
  interaction.plot(pop,site, p88)
  interaction.plot(pop, tissue, p88)
  interaction.plot(site, tissue, p88)
}
)
par(op)

##########################################
############# ANOVA for p88 ##############
##########################################
# Tissue and Site are Fixed factors
# Population is a random factor

# Testing for differences in p50 between populations
str(ovc.data.individuals)
ovc.data.individuals[,4] <- as.factor(ovc.data.individuals[,4])
ovc.data.individuals[,3] <- as.factor(ovc.data.individuals[,3])
ovc.data.individuals[,10] <- as.factor(ovc.data.individuals[,10])
an.mod <- aov(p88~tissue*site*pop,data=ovc.data.individuals)
# Start with Type II (to examine whether there are interactions between pops and sites)
f.mod1 <- Anova(lm(p88~tissue*site*pop,data=ovc.data.individuals, contrasts=list(topic=contr.sum, sys=contr.sum)), type=3)
f.mod <- Anova(an.mod, type="III")

summary(an.mod)
f.mod
ss.mod <- f.mod$`Sum Sq`[2:9]
prop.v <- matrix(NA, nrow=8, ncol=2)
prop.v <- as.data.frame(prop.v)
prop.v[,1] <- as.character(prop.v[,1])
prop.v[,2] <- as.numeric(prop.v[,2])
prop.v[,1] <- row.names(f.mod)[2:9]
for (i in c(1:8)){
  prop.v[i,2] <- ss.mod[i]/sum(ss.mod)*100    
}
round(prop.v[,2],2)
prop.v

# Post hoc tests
TukeyHSD(an.mod, "tissue")
TukeyHSD(an.mod, "site")
TukeyHSD(an.mod, "pop")

# ANOVA on separate leaf and stem databases
# what about just in the garden?
names(pe.ind.stems)
p88.i.s.g <- pe.ind.stems[pe.ind.stems$site == "H",]
an.mod <- aov(p88~pop,data=p88.i.s.g)
f.mod <- Anova(an.mod, type="III")
summary(an.mod)
f.mod
TukeyHSD(an.mod, "pop")
ss.mod <- f.mod$`Sum Sq`[2:3]
prop.v <- matrix(NA, nrow=4, ncol=2)
prop.v <- as.data.frame(prop.v)
prop.v[,1] <- as.character(prop.v[,1])
prop.v[,2] <- as.numeric(prop.v[,2])
prop.v[,1] <- row.names(f.mod)[2:3]
for (i in c(1:2)){
  prop.v[i,2] <- ss.mod[i]/sum(ss.mod)*100    
}
round(prop.v[,2],2)
prop.v

p88.i.s.w <- pe.ind.stems[pe.ind.stems$site == "W",]
an.mod <- aov(p88~pop,data=p88.i.s.w)
f.mod <- Anova(an.mod, type="III")
summary(an.mod)
f.mod
TukeyHSD(an.mod, "pop")
ss.mod <- f.mod$`Sum Sq`[2:3]
prop.v <- matrix(NA, nrow=4, ncol=2)
prop.v <- as.data.frame(prop.v)
prop.v[,1] <- as.character(prop.v[,1])
prop.v[,2] <- as.numeric(prop.v[,2])
prop.v[,1] <- row.names(f.mod)[2:3]
for (i in c(1:2)){
  prop.v[i,2] <- ss.mod[i]/sum(ss.mod)*100    
}
round(prop.v[,2],2)
prop.v

p88.i.l.g <- pe.ind.leaves[pe.ind.leaves$site == "H",]
an.mod <- aov(p88~pop,data=p88.i.l.g)
f.mod <- Anova(an.mod, type="III")
summary(an.mod)
f.mod
TukeyHSD(an.mod, "pop")
ss.mod <- f.mod$`Sum Sq`[2:3]
prop.v <- matrix(NA, nrow=4, ncol=2)
prop.v <- as.data.frame(prop.v)
prop.v[,1] <- as.character(prop.v[,1])
prop.v[,2] <- as.numeric(prop.v[,2])
prop.v[,1] <- row.names(f.mod)[2:3]
for (i in c(1:2)){
  prop.v[i,2] <- ss.mod[i]/sum(ss.mod)*100    
}
round(prop.v[,2],2)
prop.v

p88.i.l.w <- pe.ind.leaves[pe.ind.leaves$site == "W",]
an.mod <- aov(p88~pop,data=p88.i.l.w)
f.mod <- Anova(an.mod, type="III")
summary(an.mod)
f.mod
TukeyHSD(an.mod, "pop")
ss.mod <- f.mod$`Sum Sq`[2:3]
prop.v <- matrix(NA, nrow=4, ncol=2)
prop.v <- as.data.frame(prop.v)
prop.v[,1] <- as.character(prop.v[,1])
prop.v[,2] <- as.numeric(prop.v[,2])
prop.v[,1] <- row.names(f.mod)[2:3]
for (i in c(1:2)){
  prop.v[i,2] <- ss.mod[i]/sum(ss.mod)*100    
}
round(prop.v[,2],2)
prop.v

# Post hoc tests
TukeyHSD(an.mod, "site")
TukeyHSD(an.mod, "pop")

# Leaves
p88.ind.leaves <- matrix(NA, ncol=ncol(ovc.data.individuals),nrow=length(ovc.data.individuals$tissue == "leaf"))
p88.ind.leaves <- as.data.frame(p88.ind.leaves)
p88.ind.leaves <- ovc.data.individuals[ovc.data.individuals$tissue == "leaf",]
an.mod <- aov(p88~site*pop,data=p88.ind.leaves)
str(p88.ind.leaves)
f.mod <- Anova(an.mod, type="II")
summary(an.mod)
ss.mod <- f.mod$`Sum Sq`[1:4]
prop.v <- matrix(NA, nrow=4, ncol=2)
prop.v <- as.data.frame(prop.v)
prop.v[,1] <- as.character(prop.v[,1])
prop.v[,2] <- as.numeric(prop.v[,2])
prop.v[,1] <- row.names(f.mod)[1:4]
for (i in c(1:4)){
  prop.v[i,2] <- ss.mod[i]/sum(ss.mod)*100    
}
round(prop.v[,2],2)
prop.v
f.mod
# Post hoc tests
TukeyHSD(an.mod, "site")
TukeyHSD(an.mod, "pop")

##############################################################################
### Component 1I: Vulnerability to embolism of different populations - p88 ###
######################## Descriptive statistics ##############################
##############################################################################
################# Including Coefficient of variation #########################
##################### and range for various groups ###########################
##############################################################################
##############################################################################

names(ovc.data.individuals)
means.pops <- tapply(ovc.data.individuals$p88,list(ovc.data.individuals$tissue, ovc.data.individuals$pop,ovc.data.individuals$site),mean)
means.se.pops <- tapply(ovc.data.individuals$p88,list(ovc.data.individuals$tissue, ovc.data.individuals$pop,ovc.data.individuals$site),se)
# sample size of populations
ss.pops <- tapply(ovc.data.individuals$p88,list(ovc.data.individuals$tissue, ovc.data.individuals$pop,ovc.data.individuals$site),length)
# co-efficient of variation within each population
cv.pops <- tapply(ovc.data.individuals$p88,list(ovc.data.individuals$tissue, ovc.data.individuals$pop,ovc.data.individuals$site),cv)
# coefficient of variation between populations

cv(means.pops[1,,1])
cv(means.pops[2,,1])
cv(means.pops[1,,2])
cv(means.pops[2,,2])
range(means.pops[1,,1])
range(means.pops[2,,1])
range(means.pops[1,,2])
range(means.pops[2,,2])
# Garden 
# leaf
(max.diff <- range(means.pops[1,,1])[1] - range(means.pops[1,,1])[2])
# Stem
(max.diff <- range(means.pops[2,,1])[1] - range(means.pops[2,,1])[2])
# Wild
# leaf
(max.diff <- range(means.pops[1,,2])[1] - range(means.pops[1,,2])[2])
# Stem
(max.diff <- range(means.pops[2,,2])[1] - range(means.pops[2,,2])[2])

range(ovc.data.individuals[ovc.data.individuals$tissue == "leaf",8], na.rm=T)
range(ovc.data.individuals[ovc.data.individuals$tissue == "stem",8], na.rm=T)

# Finding the range within each population for leaves and stems
range.all <- matrix(NA, nrow=28, ncol=9)
range.all <- as.data.frame(range.all)
range.all[,1] <- as.character(range.all[,1])
range.all[,2] <- as.character(range.all[,2])
range.all[,3] <- as.character(range.all[,3])

range.all[,4] <- as.numeric(range.all[,4])
range.all[,5] <- as.numeric(range.all[,5])
range.all[,6] <- as.numeric(range.all[,6])
range.all[,7] <- as.numeric(range.all[,7])
range.all[,8] <- as.numeric(range.all[,8])
range.all[,9] <- as.numeric(range.all[,9])
r.l <- ovc.data.individuals[ovc.data.individuals$tissue == "leaf",]
r.s <- ovc.data.individuals[ovc.data.individuals$tissue == "stem",]
site <- c("H","W")
tissue <- c("stem","leaf")

for (i in c(1:7)){
  range.all[c(i,i+7,i+14,i+21),1] <- pops[i]
  range.all[c(i,i+14),2] <- site[1]
  range.all[c(i+7,i+21),2] <- site[2]
  range.all[c(i,i+7),3] <- tissue[2]
  range.all[c(i+14,i+21),3] <- tissue[1]
  
  range.all[i,4] <- min(r.l[r.l[,3] == site[1] & r.l[,4] == pops[i],7])
  range.all[i,5] <- max(r.l[r.l[,3] == site[1] & r.l[,4] == pops[i],7])
  
  range.all[(i+7),4] <- min(r.l[r.l[,3] == site[2] & r.l[,4] == pops[i],7])
  range.all[(i+7),5] <- max(r.l[r.l[,3] == site[2] & r.l[,4] == pops[i],7])
  
  range.all[i,6] <- min(r.l[r.l[,3] == site[1] & r.l[,4] == pops[i],8])
  range.all[i,7] <- max(r.l[r.l[,3] == site[1] & r.l[,4] == pops[i],8])
  
  range.all[(i+7),6] <- min(r.l[r.l[,3] == site[2] & r.l[,4] == pops[i],8])
  range.all[(i+7),7] <- max(r.l[r.l[,3] == site[2] & r.l[,4] == pops[i],8])
  
  range.all[i,8] <- min(r.l[r.l[,3] == site[1] & r.l[,4] == pops[i],9])
  range.all[i,9] <- max(r.l[r.l[,3] == site[1] & r.l[,4] == pops[i],9])
  
  range.all[(i+7),8] <- min(r.l[r.l[,3] == site[2] & r.l[,4] == pops[i],9])
  range.all[(i+7),9] <- max(r.l[r.l[,3] == site[2] & r.l[,4] == pops[i],9])
  
  range.all[c(i+14),4] <- min(r.s[r.s[,3] == site[1] & r.s[,4] == pops[i],7])
  range.all[c(i+14),5] <- max(r.s[r.s[,3] == site[1] & r.s[,4] == pops[i],7])
  
  range.all[c(i+21),4] <- min(r.s[r.s[,3] == site[2] & r.s[,4] == pops[i],7])
  range.all[c(i+21),5] <- max(r.s[r.s[,3] == site[2] & r.s[,4] == pops[i],7])
  
  range.all[c(i+14),6] <- min(r.s[r.s[,3] == site[1] & r.s[,4] == pops[i],8])
  range.all[c(i+14),7] <- max(r.s[r.s[,3] == site[1] & r.s[,4] == pops[i],8])
  
  range.all[c(i+21),6] <- min(r.s[r.s[,3] == site[2] & r.s[,4] == pops[i],8])
  range.all[c(i+21),7] <- max(r.s[r.s[,3] == site[2] & r.s[,4] == pops[i],8])
  
  range.all[c(i+14),8] <- min(r.s[r.s[,3] == site[1] & r.s[,4] == pops[i],9])
  range.all[c(i+14),9] <- max(r.s[r.s[,3] == site[1] & r.s[,4] == pops[i],9])
  
  range.all[c(i+21),8] <- min(r.s[r.s[,3] == site[2] & r.s[,4] == pops[i],9])
  range.all[c(i+21),9] <- max(r.s[r.s[,3] == site[2] & r.s[,4] == pops[i],9])
}
range.all
range.mag <- matrix(NA,ncol=6,nrow=28)
range.mag <- as.data.frame(range.mag)
range.mag[,1] <- as.character(range.mag[,1])
range.mag[,2] <- as.character(range.mag[,2])
range.mag[,3] <- as.character(range.mag[,3])

range.mag[,4] <- as.numeric(range.mag[,4])
range.mag[,5] <- as.numeric(range.mag[,5])
range.mag[,6] <- as.numeric(range.mag[,6])
range.mag[,1] <- range.all[,1]
range.mag[,2] <- range.all[,2]
range.mag[,3] <- range.all[,3]
range.mag[,4] <- range.all[,5] - range.all[,4]
range.mag[,5] <- range.all[,7] - range.all[,6]
range.mag[,6] <- range.all[,9] - range.all[,8]

range.mag.summary <- matrix(NA, ncol=8, nrow=4)
range.mag.summary <- as.data.frame(range.mag.summary)
(mean.max.range.p88 <- tapply(range.mag[,5],list(range.mag[,3],range.mag[,2]),mean, na.rm=T))

(mean.max.range.se.p88 <- tapply(range.mag[,5],list(range.mag[,3],range.mag[,2]),se))

range.all
cv.data <- matrix(NA, ncol=4,nrow=14)
cv.data <- as.data.frame(cv.data)
colnames(cv.data) <- c("site" ,"pop", "cv_leaf","cv_stem")
p88.garden <- ovc.data.individuals[ovc.data.individuals$site == "H",]
p88.wild <- ovc.data.individuals[ovc.data.individuals$site == "W",]
for (i in c(1:7)){
  cv.data[i,3] <- cv(p88.garden[p88.garden$tissue == "leaf" & p88.garden$pop == pops[i],8])
  cv.data[i,4] <- cv(p88.garden[p88.garden$tissue == "stem" & p88.garden$pop == pops[i],8])
  cv.data[i,2] <- pops[i]
  cv.data[i,1] <- "H"
  cv.data[(i+7),3] <- cv(p88.wild[p88.wild$tissue == "leaf" & p88.wild$pop == pops[i],8])
  cv.data[(i+7),4] <- cv(p88.wild[p88.wild$tissue == "stem" & p88.wild$pop == pops[i],8])
  cv.data[(i+7),2] <- pops[i]
  cv.data[(i+7),1] <- "W"
}
cv.data
# coefficient of variation among populations
# sorted by site (H v W) 
# mean stems
tapply(cv.data[,4],cv.data[,1],mean, na.rm=T)
tapply(cv.data[,4],cv.data[,1],se)
# mean leaves
tapply(cv.data[,3],cv.data[,1],mean, na.rm=T)
tapply(cv.data[,3],cv.data[,1],se)

# CV of each pop
# mean stems
pops.cv.stems <- tapply(cv.data[,4],cv.data[,2],mean, na.rm=T)
# mean leaves
pops.cv.leaves <- tapply(cv.data[,3],cv.data[,2],mean, na.rm=T)
# Overall
# stems
mean(pops.cv.stems)
se(pops.cv.stems)
# leaves
mean(pops.cv.leaves)
se(pops.cv.leaves)

t.test(pops.cv.leaves,pops.cv.stems)

cv.leaves <- mean(cv.data[,3], na.rm=T)
cv.stems <- mean(cv.data[,4], na.rm=T)
cv.all <- cv(ovc.data.individuals[,8])
cv.leafp88quercus <- 25.69
cv.stemp88quercus <- 27.35

cv.leaves/cv.leafp88quercus*100
cv.stems/cv.stemp88quercus*100
cv(ovc.data.individuals[ovc.data.individuals$tissue == "leaf" & ovc.data.individuals$site == "H",8])
cv(ovc.data.individuals[ovc.data.individuals$tissue == "leaf" & ovc.data.individuals$site == "W",8])
cv(ovc.data.individuals[ovc.data.individuals$tissue == "stem" & ovc.data.individuals$site == "H",8])
cv(ovc.data.individuals[ovc.data.individuals$tissue == "stem" & ovc.data.individuals$site == "W",8])

#######################################################
############ Component 1J: FigS3 P88 ##################
#######################################################

# Generate a Figure showing population mean p88 values
tiff(filename = "FigX p88 Pop means.tif",
     width = 8, height = 14, units = "cm", pointsize = 8,
     compression = c("lzw"),
     bg = "white", res = 1200, family = "", restoreConsole = TRUE,
     type = c("windows", "cairo"),antialias = "cleartype")
# boxplot for p88 values across different populations and sites
par(mfrow=c(2,1),oma=c(4,4,0.4,0.4),mar=c(0.55,0.1,0.1,0.1))
dt <- p88~pop*site
boxplot(dt, ylim=c(-8,0),axes=F,las=1,data=ovc.data.individuals[ovc.data.individuals$tissue == "leaf",],col=c("blue","purple","brown","orange","red","grey","cornflowerblue"),frame.plot=TRUE)
x.lab <- c(rep(sort(pops),2))
axis(1,at=seq(1,14,1),labels=F,tick=T,cex.axis=0.7)
axis(side=2,labels=T,tick=T,las=1)
xv <- seq(from=1,to=7, by=1)
yv <- rep(-2,7)
lines(yv~xv, col="black",lty=1,lwd=2)
text(4,-1.5,"Common Garden")
xv <- seq(from=8,to=14, by=1)
yv <- rep(-2,7)
lines(yv~xv, col="black",lty=1,lwd=2)
text(11,-1.5,"Wild populations")
text(7,-0.5,"Leaves")
text(1,-0.1,"a", font=2)
# abline(h = -3.790243, lty=2, col="black")
# abline(h = -3.790243+0.08066, lty=3, col="black")
# abline(h = -3.790243-0.08066, lty=3, col="black")
dt <- p88~pop*site
boxplot(dt, ylim=c(-8,0),axes=F,las=1,data=ovc.data.individuals[ovc.data.individuals$tissue == "stem",],col=c("blue","purple","brown","orange","red","grey","cornflowerblue"),frame.plot=TRUE)
x.lab <- c(rep(sort(pops),2))
axis(1,at=seq(1,14,1),labels=x.lab,cex.axis=0.7)
axis(side=2,labels=T,tick=T,las=1)
xv <- seq(from=1,to=7, by=1)
yv <- rep(-2,7)
lines(yv~xv, col="black",lty=1,lwd=2)
text(4,-1.5,"Common Garden")
xv <- seq(from=8,to=14, by=1)
yv <- rep(-2,7)
lines(yv~xv, col="black",lty=1,lwd=2)
text(11,-1.5,"Wild populations")
text(7,-0.5,"Stems")
text(1,-0.1,"b", font=2)
# abline(h = -4.3285, lty=2, col="black")
# abline(h = -4.3285+0.098764, lty=3, col="black")
# abline(h = -4.3285-0.098764, lty=3, col="black")
mtext("Population", side=1,outer=T, line=2, at=0.5)
mtext(expression(paste(P[88], " (MPa)")), side=2,outer=T, line=2, at=0.5)
dev.off()

# Investigating population differences
# Leaves Wild populations
x.l <- ovc.data.individuals[ovc.data.individuals$tissue == "leaf",]
x.l <- x.l[!is.na(x.l[,1]),]
x.l.wild <- x.l[x.l$site == "W",] 
data <- matrix(NA, nrow=nrow(x.l.wild),ncol=2)
data <- as.data.frame(data)
data[,1] <- as.factor(data[,1])
data[,2] <- as.numeric(data[,2])
#
data[,1] <- as.vector(x.l.wild[,4])
names(x.l.wild)
data[,2] <- as.vector(x.l.wild[,8])
str(data)
a.wild <- aov(data[,2]~as.factor(data[,1]))
Anova(a.wild, type="III")
summary(a.wild)
boxplot(data[,2]~as.factor(data[,1]))
TukeyHSD(aov(data[,2]~as.factor(data[,1])))
# Leaves common garden 
x.l <- ovc.data.individuals[ovc.data.individuals$tissue == "leaf",]
x.l <- x.l[!is.na(x.l[,1]),]
x.l.wild <- x.l[x.l$site == "H",] 
data <- matrix(NA, nrow=nrow(x.l.wild),ncol=2)
data <- as.data.frame(data)
data[,1] <- as.factor(data[,1])
data[,2] <- as.numeric(data[,2])
#
data[,1] <- as.vector(x.l.wild[,4])
data[,2] <- as.vector(x.l.wild[,8])
str(data)
a.wild <- aov(data[,2]~as.factor(data[,1]))
Anova(a.wild, type="III")
summary(a.wild)
boxplot(data[,2]~as.factor(data[,1]))
TukeyHSD(aov(data[,2]~as.factor(data[,1])))

# Stems Wild pops
x <- ovc.data.individuals[ovc.data.individuals$tissue == "stem",]
x <- x[!is.na(x[,1]),]
x.wild <- x[x$site == "W",] 
data <- matrix(NA, nrow=nrow(x.wild),ncol=2)
data <- as.data.frame(data)
data[,1] <- as.factor(data[,1])
data[,2] <- as.numeric(data[,2])
#
data[,1] <- as.vector(x.wild[,4])
data[,2] <- as.vector(x.wild[,8])
str(data)
a.wild <- aov(data[,2]~as.factor(data[,1]))
summary(a.wild)
Anova(a.wild, type="III")
boxplot(data[,2]~as.factor(data[,1]))
TukeyHSD(aov(data[,2]~as.factor(data[,1])))
# Stems garden pops
x <- ovc.data.individuals[ovc.data.individuals$tissue == "stem",]
x <- x[!is.na(x[,1]),]
x.wild <- x[x$site == "H",] 
data <- matrix(NA, nrow=nrow(x.wild),ncol=2)
data <- as.data.frame(data)
data[,1] <- as.factor(data[,1])
data[,2] <- as.numeric(data[,2])
#
data[,1] <- as.vector(x.wild[,4])
data[,2] <- as.vector(x.wild[,8])
str(data)
a.wild <- aov(data[,2]~as.factor(data[,1]))
Anova(a.wild, type="III")
summary(a.wild)
boxplot(data[,2]~as.factor(data[,1]))
TukeyHSD(aov(data[,2]~as.factor(data[,1])))

p88.means <- tapply(ovc.data.individuals[,9],list(ovc.data.individuals[,3],ovc.data.individuals[,4],ovc.data.individuals[,10]),mean,na.rm=T)
p88.means.se <- tapply(ovc.data.individuals[,9],list(ovc.data.individuals[,3],ovc.data.individuals[,4],ovc.data.individuals[,10]),se)

#######################################################################################
########### Question 2: Are there differences between leaves and stems? ###############
### I.e. Is there evidence of vulnerability segmentation between leaves and stems? ####
#######################################################################################

# next question: is there a consistent pattern to vulnerability segmentation?
vs <- p50.means[2,,2] - p50.means[2,,1] 
t.test(p50.means[2,,2],p50.means[2,,1])
stems.mean <- mean(c(p50.means[2,,2],p50.means[1,,2]))
stems.se <- se(c(p50.means[2,,2],p50.means[1,,2]))

leaves.mean <- mean(c(p50.means[2,,1],p50.means[1,,1]))
leaves.se <- se(c(p50.means[2,,1],p50.means[1,,1]))

stems.mean - leaves.mean
######################################################

### Can we do the analysis for individuals? ###
# Find the unique code for each individual
individuals <- paste(ovc.data.individuals[,3],ovc.data.individuals[,4],ovc.data.individuals[,5])
# subtract the leaf from the stem for each individual to assess the degree of segmentation within individuals
ind.diffs <- matrix(NA, nrow=length(individuals),ncol=7)
ind.diffs <- as.data.frame(ind.diffs)
ind.diffs[,1] <- as.character(ind.diffs[,1])
ind.diffs[,2] <- as.numeric(ind.diffs[,2])
ind.diffs[,3] <- as.character(ind.diffs[,3])
ind.diffs[,4] <- as.character(ind.diffs[,4])
ind.diffs[,5] <- as.character(ind.diffs[,5])
ind.diffs[,6] <- as.numeric(ind.diffs[,6])
ind.diffs[,7] <- as.numeric(ind.diffs[,7])

ind.diffs[,3] <- ovc.data.individuals[,10]
ind.diffs[,4] <- ovc.data.individuals[,3]
ind.diffs[,5] <- ovc.data.individuals[,4]
colnames(ind.diffs) <- c("tag","segmentation","tissue","site","pop", "segp12","segp88")
for (i in c(1:length(individuals))){
  ind.diffs[i,1] <- individuals[i]
  x.s <- ovc.data.individuals[ovc.data.individuals$tissue == "stem" & individuals == individuals[i],8]
  x.l <- ovc.data.individuals[ovc.data.individuals$tissue == "leaf" & individuals == individuals[i],8]
  
  x.s.12 <- ovc.data.individuals[ovc.data.individuals$tissue == "stem" & individuals == individuals[i],7]
  x.l.12 <- ovc.data.individuals[ovc.data.individuals$tissue == "leaf" & individuals == individuals[i],7]
  
  x.s.88 <- ovc.data.individuals[ovc.data.individuals$tissue == "stem" & individuals == individuals[i],9]
  x.l.88 <- ovc.data.individuals[ovc.data.individuals$tissue == "leaf" & individuals == individuals[i],9]
  ind.diffs[i,2] <-  ifelse(length(x.l) < 1 | length(x.s) < 1,NA,x.s - x.l)
  ind.diffs[i,6] <-  ifelse(length(x.l.12) < 1 | length(x.s.12) < 1,NA,x.s.12 - x.l.12)
  ind.diffs[i,7] <-  ifelse(length(x.l.88) < 1 | length(x.s.88) < 1,NA,x.s.88 - x.l.88)
}
ind.diffs <- ind.diffs[ind.diffs[,3] == "stem",]
ind.diffs <- ind.diffs[!is.na(ind.diffs[,2]),]
# segmentation of populations
seg.pops <- tapply(ind.diffs[,2],list(ind.diffs[,4],ind.diffs[,5]),mean,na.rm=T)
# sample sizes
seg.ss.pops <- tapply(ind.diffs[,2],list(ind.diffs[,4],ind.diffs[,5]),length)

seg.se.pops <- tapply(ind.diffs[,2],list(ind.diffs[,4],ind.diffs[,5]),se)
an.mod <- aov(segmentation~site*pop,data=ind.diffs)
an.f <- Anova(an.mod, type="III")
an.f
summary(an.mod)
op <- par(mfrow = c(3, 1))
with(ind.diffs, {
  interaction.plot(pop,site, segmentation,ylim=c(-2,0))
  interaction.plot(pop, tissue, segmentation,ylim=c(-2,0))
  interaction.plot(site, tissue, segmentation,ylim=c(-2,0))
}
)
par(op)
mean(seg.pops[1,])
mean(seg.pops[2,])

se(seg.pops[1,])
se(seg.pops[2,])

t.test(seg.pops[1,],seg.pops[2,])
range(seg.pops[1,])
range(seg.pops[2,])

# P12
seg.pops.12 <- tapply(ind.diffs[,6],list(ind.diffs[,4],ind.diffs[,5]),mean,na.rm=T)
seg.ss.pops.12 <- tapply(ind.diffs[,6],list(ind.diffs[,4],ind.diffs[,5]),length)

seg.se.pops.12 <- tapply(ind.diffs[,6],list(ind.diffs[,4],ind.diffs[,5]),se)
an.mod <- aov(segp12~site*pop,data=ind.diffs)
an.f <- Anova(an.mod, type="II")
an.f
summary(an.mod)
op <- par(mfrow = c(3, 1))
with(ind.diffs, {
  interaction.plot(pop,site, segp12,ylim=c(-2,0))
  interaction.plot(pop, tissue, segp12,ylim=c(-2,0))
  interaction.plot(site, tissue, segp12,ylim=c(-2,0))
}
)
par(op)
mean(seg.pops.12[1,])
mean(seg.pops.12[2,])

se(seg.pops.12[1,])
se(seg.pops.12[2,])

t.test(seg.pops.12[1,],seg.pops.12[2,])
range(seg.pops.12[1,])
range(seg.pops.12[2,])

# P88
seg.pops.88 <- tapply(ind.diffs[,7],list(ind.diffs[,4],ind.diffs[,5]),mean,na.rm=T)
seg.ss.pops.88 <- tapply(ind.diffs[,7],list(ind.diffs[,4],ind.diffs[,5]),length)

seg.se.pops.88 <- tapply(ind.diffs[,7],list(ind.diffs[,4],ind.diffs[,5]),se)
an.mod <- aov(segp88~site*pop,data=ind.diffs)
an.f <- Anova(an.mod, type="II")
an.f
summary(an.mod)
op <- par(mfrow = c(3, 1))
with(ind.diffs, {
  interaction.plot(pop,site, segp88,ylim=c(-2,0))
  interaction.plot(pop, tissue, segp88,ylim=c(-2,0))
  interaction.plot(site, tissue, segp88,ylim=c(-2,0))
}
)
par(op)
mean(seg.pops.88[1,])
mean(seg.pops.88[2,])

se(seg.pops.88[1,])
se(seg.pops.88[2,])

t.test(seg.pops.88[1,],seg.pops.88[2,])
range(seg.pops[1,])
range(seg.pops[2,])

seg.pops
seg.pops.12
seg.pops.88
seg.se.pops.12
seg.se.pops.88
t.test(seg.pops.12[2,],seg.pops[2,])
t.test(seg.pops.12[2,],seg.pops.88[2,])
t.test(seg.pops[2,],seg.pops.88[2,])
t.test(seg.pops.12[2,],seg.pops.12[1,])
t.test(seg.pops[2,],seg.pops[1,])

####################################################################################################
# Question 3: What environmental factors may play a role in determining vulnerability to embolism? #
####################################################################################################
###################################################################################
# Analysis of the environmental drivers of variation in vulnerability to embolism #
###################################################################################
# Load met data with information for each different population
meta.data <- read.table("blue oak extracted environment and dieback.txt", header=T)
names(meta.data)
meta.data <- read.csv("pop_info_9-Feb-2019.csv", header=T)
# Match our pops with newpopnumber in meta.data
names(hopland.leaf)
pops <- unique(hopland.leaf[,12])
pops.sorted <- sort(pops)
c.pops.sorted <- c(pops.sorted, "H")
hu <- meta.data[meta.data$newpopnumber %in% c.pops.sorted,]
these.rows <- match(pops.sorted,meta.data$newpopnumber)
elev.pops <- meta.data[these.rows,6]
aet.pops <- meta.data[these.rows,16]
pet.pops <- meta.data[these.rows,15]
cwd.pops <- meta.data[these.rows,9]
djf.pops <- meta.data[these.rows,11]
jja.pops <- meta.data[these.rows,12]
ai.pops <- c(meta.data[these.rows,10]/meta.data[these.rows,15])
ppt.pops <- meta.data[these.rows,10]
tmn.pops <- meta.data[these.rows,13]
tmx.pops <- meta.data[these.rows,14]
hop.cwd <- meta.data[which(meta.data[,17] == "H"),9]
hop.aet <- meta.data[which(meta.data[,17] == "H"),16]
hop.ai <- meta.data[which(meta.data[,17] == "H"),10]/meta.data[which(meta.data[,17] == "H"),15]
pairs(meta.data[,c(9:16)])
# plotting met variables against each other
plot(cwd.pops~ai.pops)
plot(cwd.pops~ppt.pops)
plot(cwd.pops~tmx.pops)

cor.met <- lm(cwd.pops~tmx.pops)
summary(cor.met)
# is there a correlation between CV within each pop and aridity or CWD?
cor.test(cv.pops[2,,1],cwd.pops, method="spearman")
cor.test(cv.pops[2,,2],cwd.pops, method="spearman")

pops.inds <- ovc.data.individuals$pop
these.rows <- match(pops.inds,meta.data$newpopnumber)
names(meta.data)
cwd.pops.all <- meta.data[these.rows,9]
ai.pops.all <- meta.data[these.rows,10]/meta.data[these.rows,15]
pet.pops.all <- meta.data[these.rows,15]
aet.pops.all <- meta.data[these.rows,16]
ppt.pops.all <- meta.data[these.rows,10]
tmax.pops.all <- meta.data[these.rows,14]
jja.pops.all <- meta.data[these.rows,12]
ncol(ovc.data.individuals)
names(ovc.data.individuals)
ovc.data.individuals[,11] <- cwd.pops.all
ovc.data.individuals[,12] <- tmax.pops.all
ovc.data.individuals[,13] <- ai.pops.all
ovc.data.individuals[,14] <- jja.pops.all
ovc.data.individuals[,15] <- ppt.pops.all
ovc.data.individuals[,16] <- aet.pops.all
ovc.data.individuals[,17] <- pet.pops.all
colnames(ovc.data.individuals) <- c("Genus","species","site","pop","ind","pe","p12","p50",
                                    "p88","tissue","cwd","tmax","ai","jja","ppt","aet","pet")
                                    
######################################################################
############ Vulnerability plotted against met variables #############
######################################################################

#############
#### CWD ####
#############

################################ 
# Annual CWD - historical #
################################
tiff(filename = "FigX P50 CWD.tif",
     width = 5, height = 9, units = "cm", pointsize = 8,
     compression = c("lzw"),
     bg = "white", res = 1200, family = "", restoreConsole = TRUE,
     type = c("windows", "cairo"),antialias = "cleartype")
# P50 and CWD
par(mfrow=c(2,1),oma=c(4,3,0.4,0.4),mar=c(0.55,0.01,0.1,0.1),mgp=c(3,0.5,0))
# leaves
plot(p50~cwd,data=ovc.data.individuals[ovc.data.individuals$tissue == "leaf" & ovc.data.individuals$site == "W",],axes=F,ylim=c(-6,0),xlim=c(600,1000),pch=16,xaxt="n",yaxt="n",col="purple")
arrows(meta.data[meta.data$newpopnumber=="H",9],-5.7,meta.data[meta.data$newpopnumber=="H",9],-6,code=2,length=0.05,angle=45,lwd = 1.8)
text(810,-5.75,"Garden")
box(lwd=0.8)
axis(side=1,labels=F,tick=T,lwd=0.8)
axis(side=2,labels=T,tick=T,lwd=0.8,las=1)
lmod.cwd <- lm(p50~cwd,data=ovc.data.individuals[ovc.data.individuals$tissue == "leaf" & ovc.data.individuals$site == "W",])
summary(lmod.cwd)
xv <- seq(from=670,to=1000,by=1)
yv <- predict(lmod.cwd,newdata=data.frame(cwd=xv))
lines(yv~xv,lwd=1.2, lty=2, col=addTrans("purple",80))
# arrows(tmx.pops, p50.means[2,,1]+p50.means.se[2,,1],tmx.pops,p50.means[2,,1]-p50.means.se[2,,1],code=3, angle=90,length=0.01, col="purple")
# points(p50.means[2,,1]~tmx.pops,ylim=c(-6,0),pch=15,xaxt="n",yaxt="n",col="purple",cex=1.2)
points(p50~cwd,data=ovc.data.individuals[ovc.data.individuals$tissue == "leaf" & ovc.data.individuals$site == "H",],ylim=c(-6,0),pch=16,xaxt="n",yaxt="n",col="orange")
lmod.cwd <- lm(p50~cwd,data=ovc.data.individuals[ovc.data.individuals$tissue == "leaf" & ovc.data.individuals$site == "H",])
xv <- seq(from=670,to=1000,by=1)
yv <- predict(lmod.cwd,newdata=data.frame(cwd=xv))
lines(yv~xv,lwd=1.5, lty=2, col=addTrans("orange",80))
summary(lmod.cwd)
# arrows(tmx.pops, p50.means[1,,1]+p50.means.se[1,,1],tmx.pops,p50.means[1,,1]-p50.means.se[1,,1],code=3, angle=90,length=0.01, col="orange")
# points(p50.means[1,,1]~tmx.pops,ylim=c(-6,0),pch=15,col="orange")
# lm.tmx <- lm(p50.means[1,,1]~tmx.pops)
# summary(lm.tmx)

# # ANCOVA
# lmod.tmx <- aov(p50~cwd+site,data=ovc.data.individuals[ovc.data.individuals$tissue == "leaf",])
# Anova(lmod.tmx, type="III")
# summary.lm(lmod.tmx)

mtext(side=1,line=2,outer=T,"Historical Mean",at=0.5)
mtext(side=1,line=3,outer=T,expression(paste("Annual CWD (mm)")), at=0.5)
mtext(side=2,line=1.8,outer=T,expression(paste(P[50]," (MPa)")))
text(690,-1.75,"Leaves")
text(605,-0.15,"a",font=2)
legend(650,-0.05, c("Wild","Garden"), pch=c(16,16), col=c("purple","orange"), ncol=2)
# Stems
plot(p50~cwd,data=ovc.data.individuals[ovc.data.individuals$tissue == "stem" & ovc.data.individuals$site == "W",],axes=F,ylim=c(-6,0),xlim=c(600,1000),pch=16,xaxt="n",yaxt="n",col="purple")
lmod.cwd <- lm(p50~cwd,data=ovc.data.individuals[ovc.data.individuals$tissue == "stem" & ovc.data.individuals$site == "W",])
# abline(lmod.cwd, lwd=1.5, lty=2, col="purple")
summary(lmod.cwd)
box(lwd=0.8)
axis(side=1,labels=T,tick=T,lwd=0.8)
axis(side=2,labels=T,tick=T,lwd=0.8,las=1)
xv <- seq(from=670,to=1000,by=1)
yv <- predict(lmod.cwd,newdata=data.frame(cwd=xv))
lines(yv~xv,lwd=1.5, lty=1, col=addTrans("purple",180))
p <- round(coefficients(summary(lmod.cwd))[8],3)
r2 <- round(as.vector(summary(lmod.cwd)[[8]]),2)
text(880,-2,expression(paste("p = 0.03")))
text(880,-2.5,expression(paste(r^2," = 0.12")))
points(p50~cwd,data=ovc.data.individuals[ovc.data.individuals$tissue == "stem" & ovc.data.individuals$site == "H",],ylim=c(-6,0),xlim=c(600,1000),pch=16,xaxt="n",yaxt="n",col="orange")
lmod.cwd <- lm(p50~cwd,data=ovc.data.individuals[ovc.data.individuals$tissue == "stem" & ovc.data.individuals$site == "H",])
# abline(lmod.cwd, lwd=1.5, lty=2, col="orange")
summary(lmod.cwd)
xv <- seq(from=670,to=1000,by=1)
yv <- predict(lmod.cwd,newdata=data.frame(cwd=xv))
lines(yv~xv,lwd=1.5, lty=2, col=addTrans("orange",80))

text(680,-1.75,"Stems")
text(605,-0.25,"b",font=2)
dev.off()
################################ 
# Annual Max Temp - historical #
################################
tiff(filename = "FigX P50 annual tmax.tif",
     width = 7, height = 12, units = "cm", pointsize = 8,
     compression = c("lzw"),
     bg = "white", res = 1200, family = "", restoreConsole = TRUE,
     type = c("windows", "cairo"),antialias = "cleartype")
# P50 and tmax
# par(mfrow=c(2,1),oma=c(4,4,0.4,0.4),mar=c(0.55,1,0.1,0.1),mgp=c(3,0.5,0))
# leaves
plot(p50~tmax,data=ovc.data.individuals[ovc.data.individuals$tissue == "leaf" & ovc.data.individuals$site == "W",],axes=F,ylim=c(-6,0),xlim=c(20,25),pch=16,xaxt="n",yaxt="n",col="purple")
arrows(meta.data[meta.data$Code=="H",14],-5,meta.data[meta.data$newpopnumber=="H",14],-6,code=2,length=0.05,angle=45,lwd = 1.8)
text(23,-5.5,"Garden")
box(lwd=0.8)
axis(side=1,labels=F,tick=T,lwd=0.8)
axis(side=2,labels=F,tick=T,lwd=0.8,las=1)
lmod.tmax <- lm(p50~tmax,data=ovc.data.individuals[ovc.data.individuals$tissue == "leaf" & ovc.data.individuals$site == "W",])
summary(lmod.tmax)
xv <- seq(from=20,to=25,by=1)
yv <- predict(lmod.tmax,newdata=data.frame(tmax=xv))
lines(yv~xv,lwd=1.2, lty=2, col=addTrans("purple",80))
# arrows(tmx.pops, p50.means[2,,1]+p50.means.se[2,,1],tmx.pops,p50.means[2,,1]-p50.means.se[2,,1],code=3, angle=90,length=0.01, col="purple")
# points(p50.means[2,,1]~tmx.pops,ylim=c(-6,0),pch=15,xaxt="n",yaxt="n",col="purple",cex=1.2)
points(p50~tmax,data=ovc.data.individuals[ovc.data.individuals$tissue == "leaf" & ovc.data.individuals$site == "H",],ylim=c(-6,0),pch=16,xaxt="n",yaxt="n",col="orange")
lmod.tmax <- lm(p50~tmax,data=ovc.data.individuals[ovc.data.individuals$tissue == "leaf" & ovc.data.individuals$site == "H",])
xv <- seq(from=20,to=25,by=0.05)
yv <- predict(lmod.tmax,newdata=data.frame(tmax=xv))
lines(yv~xv,lwd=1.5, lty=2, col="orange")
summary(lmod.tmax)
# p <- round(coefficients(summary(lmod.tmax))[8],3)
# r2 <- round(as.vector(summary(lmod.tmax)[[8]]),2)
# text(24,-2,expression(paste("p = 0.015")))
# text(24,-2.5,expression(paste(r^2," = 0.32")))
# arrows(tmx.pops, p50.means[1,,1]+p50.means.se[1,,1],tmx.pops,p50.means[1,,1]-p50.means.se[1,,1],code=3, angle=90,length=0.01, col="orange")
# points(p50.means[1,,1]~tmx.pops,ylim=c(-6,0),pch=15,col="orange")
# lm.tmx <- lm(p50.means[1,,1]~tmx.pops)
# summary(lm.tmx)

# # ANCOVA
# lmod.tmx <- aov(p50~tmax+site,data=ovc.data.individuals[ovc.data.individuals$tissue == "leaf",])
# Anova(lmod.tmx, type="III")
# summary.lm(lmod.tmx)

mtext(side=1,line=2,outer=T,"Historical Mean Monthly",at=0.76)
mtext(side=1,line=3,outer=T,expression(paste("Maximum Temp. (",degree,"C)")), at=0.76)
mtext(side=2,line=2,outer=T,expression(paste(P[50]," (MPa)")))
text(21,-1.75,"Leaves")
text(20,-0.15,"c",font=2)
# legend(20.5,-0.05, c("Wild","Garden"), pch=c(16,16), col=c("purple","orange"), ncol=2)
# Stems
plot(p50~tmax,data=ovc.data.individuals[ovc.data.individuals$tissue == "stem" & ovc.data.individuals$site == "W",],axes=F,ylim=c(-6,0),xlim=c(20,25),pch=16,xaxt="n",yaxt="n",col="purple")
lmod.tmax <- lm(p50~tmax,data=ovc.data.individuals[ovc.data.individuals$tissue == "stem" & ovc.data.individuals$site == "W",])
# abline(lmod.tmax, lwd=1.5, lty=2, col="purple")
summary(lmod.tmax)
box(lwd=0.8)
axis(side=1,labels=T,tick=T,lwd=0.8)
axis(side=2,labels=F,tick=T,lwd=0.8,las=1)
xv <- seq(from=20,to=25,by=0.05)
yv <- predict(lmod.tmax,newdata=data.frame(tmax=xv))
lines(yv~xv,lwd=1.5, lty=2, col=addTrans("purple",80))
# arrows(tmx.pops, p50.means[2,,2]+p50.means.se[2,,2],tmx.pops,p50.means[2,,2]-p50.means.se[2,,2],code=3, angle=90,length=0.01, col="purple")
# points(p50.means[2,,2]~tmx.pops,ylim=c(-6,0),xlim=c(600,1000),pch=15,xaxt="n",yaxt="n",col="purple",cex=1.2)
points(p50~tmax,data=ovc.data.individuals[ovc.data.individuals$tissue == "stem" & ovc.data.individuals$site == "H",],ylim=c(-6,0),xlim=c(600,1000),pch=16,xaxt="n",yaxt="n",col="orange")
lmod.tmax <- lm(p50~tmax,data=ovc.data.individuals[ovc.data.individuals$tissue == "stem" & ovc.data.individuals$site == "H",])
# abline(lmod.tmax, lwd=1.5, lty=2, col="orange")
summary(lmod.tmax)
xv <- seq(from=20,to=25,by=0.05)
yv <- predict(lmod.tmax,newdata=data.frame(tmax=xv))
lines(yv~xv,lwd=1.5, lty=2, col=addTrans("orange",80))
# arrows(tmx.pops, p50.means[1,,2]+p50.means.se[1,,2],tmx.pops,p50.means[1,,2]-p50.means.se[1,,2],code=3, angle=90,length=0.01, col="orange")
# points(p50.means[1,,2]~tmx.pops,ylim=c(-6,0),xlim=c(600,1000),pch=15,col="orange")
# lm.tmx <- lm(p50.means[1,,2]~tmx.pops)
# summary(lm.tmx)
text(21,-1.75,"Stems")
text(20,-0.25,"d",font=2)
dev.off()

# ######## Differences between wild and garden pops plotted against CWD ########
# # wild - garden
# diff.l <- p50.means[2,,1] - p50.means[1,,1]  
# diff.s <- p50.means[2,,2] - p50.means[1,,2]
# 
# # differences between wild and garden populations
# par(mfrow=c(2,1),oma=c(4,4,0.4,0.4), mar=c(2,2,0.1,0.1))
# plot(diff.l~cwd.pops, ylim=c(-1,1))
# abline(h=0,lty=3)
# lm.d <- lm(diff.l~cwd.pops)
# summary(lm.d)
# 
# plot(diff.s~cwd.pops, ylim=c(-1,1))
# abline(h=0,lty=3)
# # not much to write home about here
# 
# ######## What about the differences between wild and garden pops plotted against DIFFERENCE ###
# ######################## in CWD between garden and wild site ##################################
# # wild - garden
# diff.l <- p50.means[2,,1] - p50.means[1,,1]  
# diff.s <- p50.means[2,,2] - p50.means[1,,2]
# 
# names(meta.data)
# 
# tmx.diff <- tmx.pops - meta.data[22,21]
# cwd.diff <- cwd.pops - hop.cwd
# # differences between wild and garden populations
# par(mfrow=c(2,1),oma=c(4,4,0.4,0.4), mar=c(2,2,0.1,0.1))
# plot(diff.l~cwd.diff, ylim=c(-1,1))
# abline(h=0,lty=3)
# lm.d <- lm(diff.l~cwd.diff)
# summary(lm.d)
# abline(lm.d)
# plot(diff.s~cwd.diff, ylim=c(-1,1))
# abline(h=0,lty=3)
# 
# # differences between wild and garden populations
# par(mfrow=c(2,1),oma=c(4,4,0.4,0.4), mar=c(2,2,0.1,0.1))
# plot(diff.l~tmx.diff, ylim=c(-1,1))
# abline(h=0,lty=3)
# lm.d <- lm(diff.l~tmx.diff)
# summary(lm.d)
# abline(lm.d)
# plot(diff.s~tmx.diff, ylim=c(-1,1))
# abline(h=0,lty=3)
# lm.d <- lm(diff.s~tmx.diff)
# summary(lm.d)

#########################################
## Continuing with other met variables ##
#########################################
############
#### AI ####
############

# plot pe values against Aridity Index
tiff(filename = "FigX P50 AI.tif",
     width = 7, height = 12, units = "cm", pointsize = 8,
     compression = c("lzw"),
     bg = "white", res = 1200, family = "", restoreConsole = TRUE,
     type = c("windows", "cairo"),antialias = "cleartype")
# P50 and ai
par(mfrow=c(2,1),oma=c(4,4,0.4,0.4),mar=c(0.55,1,0.1,0.1),mgp=c(3,0.5,0))
# leaves
plot(p50~ai,data=ovc.data.individuals[ovc.data.individuals$tissue == "leaf" & ovc.data.individuals$site == "W",],axes=F,ylim=c(-6,0),xlim=c(0,1.2),pch=16,xaxt="n",yaxt="n",col="purple")
arrows(c(meta.data[meta.data$newpopnumber=="H",10]/meta.data[meta.data$newpopnumber=="H",15]),-5,c(meta.data[meta.data$newpopnumber=="H",10]/meta.data[meta.data$newpopnumber=="H",15]),-6,code=2,length=0.05,angle=45,lwd = 1.8)
text(1,-5.5,"Garden")
lmod.ai <- lm(p50~ai,data=ovc.data.individuals[ovc.data.individuals$tissue == "leaf" & ovc.data.individuals$site == "W",])
summary(lmod.ai)
box(lwd=0.8)
xv <- seq(from=0.2,to=1.2,by=1)
yv <- predict(lmod.ai,newdata=data.frame(ai=xv))
lines(yv~xv,lwd=1.2, lty=2, col=addTrans("purple",80))
axis(side=1,labels=F,tick=T,lwd=0.8)
axis(side=2,labels=T,tick=T,lwd=0.8,las=1)
arrows(ai.pops, p50.means[2,,1]+p50.means.se[2,,1],ai.pops,p50.means[2,,1]-p50.means.se[2,,1],code=3, angle=90,length=0.01, col="purple")
points(p50.means[2,,1]~ai.pops,ylim=c(-6,0),pch=15,xaxt="n",yaxt="n",col="purple",cex=1.2)
points(p50~ai,data=ovc.data.individuals[ovc.data.individuals$tissue == "leaf" & ovc.data.individuals$site == "H",],ylim=c(-6,0),pch=16,xaxt="n",yaxt="n",col="orange")
lmod.ai <- lm(p50~ai,data=ovc.data.individuals[ovc.data.individuals$tissue == "leaf" & ovc.data.individuals$site == "H",])
summary(lmod.ai)
xv <- seq(from=0.2,to=1.2,by=0.05)
yv <- predict(lmod.ai,newdata=data.frame(ai=xv))
lines(yv~xv,lwd=1.5, lty=2, col="orange")
p <- round(coefficients(summary(lmod.ai))[8],3)
r2 <- round(as.vector(summary(lmod.ai)[[8]]),2)
# text(900,-2.3,expression(paste("p = 0.048")))
# text(900,-2.8,expression(paste(r^2," = 0.22")))
arrows(ai.pops, p50.means[1,,1]+p50.means.se[1,,1],ai.pops,p50.means[1,,1]-p50.means.se[1,,1],code=3, angle=90,length=0.01, col="orange")
points(p50.means[1,,1]~ai.pops,ylim=c(-6,0),pch=15,col="orange")
mtext(side=1,line=2,outer=T,"Historical Aridity Index")
mtext(side=2,line=2,outer=T,expression(paste(P[50]," (MPa)")))
text(0.3,-1.75,"Leaves")
text(0,-0.15,"a",font=2)
legend(0.2,-0.05, c("Wild","Garden","Individual","Pop. mean"), pch=c(15,15,1,15), col=c("purple","orange", "black", "black"), ncol=2)
# Stems
plot(p50~ai,data=ovc.data.individuals[ovc.data.individuals$tissue == "stem" & ovc.data.individuals$site == "W",],axes=F,ylim=c(-6,0),xlim=c(0,1.2),pch=16,xaxt="n",yaxt="n",col="purple")
lmod.ai <- lm(p50~ai,data=ovc.data.individuals[ovc.data.individuals$tissue == "stem" & ovc.data.individuals$site == "W",])
# abline(lmod.ai, lwd=1.5, lty=2, col="purple")
summary(lmod.ai)
box(lwd=0.8)
axis(side=1,labels=T,tick=T,lwd=0.8)
axis(side=2,labels=T,tick=T,lwd=0.8,las=1)
arrows(ai.pops, p50.means[2,,2]+p50.means.se[2,,2],ai.pops,p50.means[2,,2]-p50.means.se[2,,2],code=3, angle=90,length=0.01, col="purple")
points(p50.means[2,,2]~ai.pops,ylim=c(-6,0),xlim=c(600,1000),pch=15,xaxt="n",yaxt="n",col="purple",cex=1.2)
points(p50~ai,data=ovc.data.individuals[ovc.data.individuals$tissue == "stem" & ovc.data.individuals$site == "H",],ylim=c(-6,0),xlim=c(600,1000),pch=16,xaxt="n",yaxt="n",col="orange")
lmod.ai <- lm(p50~ai,data=ovc.data.individuals[ovc.data.individuals$tissue == "stem" & ovc.data.individuals$site == "H",])
# abline(lmod.ai, lwd=1.5, lty=2, col="orange")
summary(lmod.ai)
arrows(ai.pops, p50.means[1,,2]+p50.means.se[1,,2],ai.pops,p50.means[1,,2]-p50.means.se[1,,2],code=3, angle=90,length=0.01, col="orange")
points(p50.means[1,,2]~ai.pops,ylim=c(-6,0),xlim=c(600,1000),pch=15,col="orange")
text(0.2,-1.75,"Stems")
text(0,-0.25,"b",font=2)
dev.off()

##################
#### Rainfall ####
##################
# plot pe values against ppt
tiff(filename = "FigX P50 ppt.tif",
     width = 7, height = 12, units = "cm", pointsize = 8,
     compression = c("lzw"),
     bg = "white", res = 1200, family = "", restoreConsole = TRUE,
     type = c("windows", "cairo"),antialias = "cleartype")
# P50 and ai
par(mfrow=c(2,1),oma=c(4,4,0.4,0.4),mar=c(0.55,1,0.1,0.1),mgp=c(3,0.5,0))
# leaves
plot(p50~ppt,data=ovc.data.individuals[ovc.data.individuals$tissue == "leaf" & ovc.data.individuals$site == "W",],axes=F,ylim=c(-6,0),xlim=c(400,1300),pch=16,xaxt="n",yaxt="n",col="purple")
arrows(meta.data[meta.data$newpopnumber=="H",10],-5,meta.data[meta.data$newpopnumber=="H",10],-6,code=2,length=0.05,angle=45,lwd = 1.8)
text(1,-5.5,"Garden")
lmod.ppt <- lm(p50~ppt,data=ovc.data.individuals[ovc.data.individuals$tissue == "leaf" & ovc.data.individuals$site == "W",])
summary(lmod.ppt)
box(lwd=0.8)
xv <- seq(from=400,to=1200,by=1)
yv <- predict(lmod.ppt,newdata=data.frame(ppt=xv))
lines(yv~xv,lwd=1.2, lty=2, col=addTrans("purple",80))
axis(side=1,labels=F,tick=T,lwd=0.8)
axis(side=2,labels=T,tick=T,lwd=0.8,las=1)
points(p50~ppt,data=ovc.data.individuals[ovc.data.individuals$tissue == "leaf" & ovc.data.individuals$site == "H",],ylim=c(-6,0),pch=16,xaxt="n",yaxt="n",col="orange")
lmod.ppt <- lm(p50~ppt,data=ovc.data.individuals[ovc.data.individuals$tissue == "leaf" & ovc.data.individuals$site == "H",])
summary(lmod.ppt)
xv <- seq(from=400,to=1200,by=0.05)
yv <- predict(lmod.ppt,newdata=data.frame(ppt=xv))
lines(yv~xv,lwd=1.5, lty=2, col="orange")
p <- round(coefficients(summary(lmod.ppt))[8],3)
r2 <- round(as.vector(summary(lmod.ppt)[[8]]),2)
# text(900,-2.3,expression(paste("p = 0.048")))
# text(900,-2.8,expression(paste(r^2," = 0.22")))
mtext(side=1,line=2,outer=T,"Historical PPT")
mtext(side=2,line=2,outer=T,expression(paste(P[50]," (MPa)")))
text(0.3,-1.75,"Leaves")
text(0,-0.15,"a",font=2)
legend(0.2,-0.05, c("Wild","Garden","Individual","Pop. mean"), pch=c(15,15,1,15), col=c("purple","orange", "black", "black"), ncol=2)
# Stems
plot(p50~ppt,data=ovc.data.individuals[ovc.data.individuals$tissue == "stem" & ovc.data.individuals$site == "W",],axes=F,ylim=c(-6,0),xlim=c(400,1300),pch=16,xaxt="n",yaxt="n",col="purple")
lmod.ppt <- lm(p50~ppt,data=ovc.data.individuals[ovc.data.individuals$tissue == "stem" & ovc.data.individuals$site == "W",])
# abline(lmod.ai, lwd=1.5, lty=2, col="purple")
summary(lmod.ppt)
box(lwd=0.8)
axis(side=1,labels=T,tick=T,lwd=0.8)
axis(side=2,labels=T,tick=T,lwd=0.8,las=1)
points(p50~ppt,data=ovc.data.individuals[ovc.data.individuals$tissue == "stem" & ovc.data.individuals$site == "H",],ylim=c(-6,0),xlim=c(600,1000),pch=16,xaxt="n",yaxt="n",col="orange")
lmod.ppt <- lm(p50~ppt,data=ovc.data.individuals[ovc.data.individuals$tissue == "stem" & ovc.data.individuals$site == "H",])
# abline(lmod.ai, lwd=1.5, lty=2, col="orange")
summary(lmod.ppt)
text(0.2,-1.75,"Stems")
text(0,-0.25,"b",font=2)
dev.off()

###########
### JJA ###
###########
tiff(filename = "FigX P50 jja.tif",
     width = 7, height = 12, units = "cm", pointsize = 8,
     compression = c("lzw"),
     bg = "white", res = 1200, family = "", restoreConsole = TRUE,
     type = c("windows", "cairo"),antialias = "cleartype")
# P50 and jja
par(mfrow=c(2,1),oma=c(4,4,0.4,0.4),mar=c(0.55,1,0.1,0.1),mgp=c(3,0.5,0))
# leaves
plot(p50~jja,data=ovc.data.individuals[ovc.data.individuals$tissue == "leaf" & ovc.data.individuals$site == "W",],axes=F,ylim=c(-6,0),xlim=c(30,36),pch=16,xaxt="n",yaxt="n",col="purple")
arrows(meta.data[meta.data$newpopnumber=="H",12],-5,meta.data[meta.data$newpopnumber=="H",12],-6,code=2,length=0.05,angle=45,lwd = 1.8)
text(32.25,-5.5,"Garden")
lmod.jja <- lm(p50~jja,data=ovc.data.individuals[ovc.data.individuals$tissue == "leaf" & ovc.data.individuals$site == "W",])
summary(lmod.jja)
box(lwd=0.8)
xv <- seq(from=30,to=36,by=0.05)
yv <- predict(lmod.jja,newdata=data.frame(jja=xv))
lines(yv~xv,lwd=1.2, lty=2, col=addTrans("purple",80))
axis(side=1,labels=F,tick=T,lwd=0.8)
axis(side=2,labels=T,tick=T,lwd=0.8,las=1)
# arrows(jja.pops, p50.means[2,,1]+p50.means.se[2,,1],jja.pops,p50.means[2,,1]-p50.means.se[2,,1],code=3, angle=90,length=0.01, col="purple")
# points(p50.means[2,,1]~jja.pops,ylim=c(-6,0),pch=15,xaxt="n",yaxt="n",col="purple",cex=1.2)
points(p50~jja,data=ovc.data.individuals[ovc.data.individuals$tissue == "leaf" & ovc.data.individuals$site == "H",],ylim=c(-6,0),pch=16,xaxt="n",yaxt="n",col="orange")
lmod.jja <- lm(p50~jja,data=ovc.data.individuals[ovc.data.individuals$tissue == "leaf" & ovc.data.individuals$site == "H",])
xv <- seq(from=30,to=36,by=0.05)
yv <- predict(lmod.jja,newdata=data.frame(jja=xv))
lines(yv~xv,lwd=1.5, lty=1, col="orange")
summary(lmod.jja)
# summary(lm.jja)
mtext(side=1,line=2,outer=T,expression(paste("Historical Mean Max. Temp. for JJA (",degree,"C)")))
mtext(side=2,line=2,outer=T,expression(paste(P[50]," (MPa)")))
text(31,-1.75,"Leaves")
text(30,-0.15,"a",font=2)
legend(30.5,-0.05, c("Wild","Garden","Individual","Pop. mean"), pch=c(15,15,1,15), col=c("purple","orange", "black", "black"), ncol=2)
# Stems
plot(p50~jja,data=ovc.data.individuals[ovc.data.individuals$tissue == "stem" & ovc.data.individuals$site == "W",],axes=F,ylim=c(-6,0),xlim=c(30,36),pch=16,xaxt="n",yaxt="n",col="purple")
lmod.jja <- lm(p50~jja,data=ovc.data.individuals[ovc.data.individuals$tissue == "stem" & ovc.data.individuals$site == "W",])
# abline(lmod.jja, lwd=1.5, lty=2, col="purple")
summary(lmod.jja)
box(lwd=0.8)
axis(side=1,labels=T,tick=T,lwd=0.8)
axis(side=2,labels=T,tick=T,lwd=0.8,las=1)
# arrows(jja.pops, p50.means[2,,2]+p50.means.se[2,,2],jja.pops,p50.means[2,,2]-p50.means.se[2,,2],code=3, angle=90,length=0.01, col="purple")
# points(p50.means[2,,2]~jja.pops,ylim=c(-6,0),xlim=c(600,1000),pch=15,xaxt="n",yaxt="n",col="purple",cex=1.2)
points(p50~jja,data=ovc.data.individuals[ovc.data.individuals$tissue == "stem" & ovc.data.individuals$site == "H",],ylim=c(-6,0),xlim=c(600,1000),pch=16,xaxt="n",yaxt="n",col="orange")
lmod.jja <- lm(p50~jja,data=ovc.data.individuals[ovc.data.individuals$tissue == "stem" & ovc.data.individuals$site == "H",])
# abline(lmod.jja, lwd=1.5, lty=2, col="orange")
summary(lmod.jja)
# arrows(jja.pops, p50.means[1,,2]+p50.means.se[1,,2],jja.pops,p50.means[1,,2]-p50.means.se[1,,2],code=3, angle=90,length=0.01, col="orange")
# points(p50.means[1,,2]~jja.pops,ylim=c(-6,0),xlim=c(600,1000),pch=15,col="orange")
lm.jja <- lm(p50.means[1,,2]~jja.pops)
# summary(lm.jja)
text(31,-1.75,"Stems")
text(30,-0.25,"b",font=2)
dev.off()

###########
### PET ###
###########
tiff(filename = "FigX P50 pet.tif",
     width = 7, height = 12, units = "cm", pointsize = 8,
     compression = c("lzw"),
     bg = "white", res = 1200, family = "", restoreConsole = TRUE,
     type = c("windows", "cairo"),antialias = "cleartype")
# P50 and jja
par(mfrow=c(2,1),oma=c(4,4,0.4,0.4),mar=c(0.55,1,0.1,0.1),mgp=c(3,0.5,0))
# leaves
plot(p50~pet,data=ovc.data.individuals[ovc.data.individuals$tissue == "leaf" & ovc.data.individuals$site == "W",],axes=F,ylim=c(-6,0),xlim=c(30,36),pch=16,xaxt="n",yaxt="n",col="purple")
arrows(meta.data[meta.data$newpopnumber=="H",12],-5,meta.data[meta.data$newpopnumber=="H",12],-6,code=2,length=0.05,angle=45,lwd = 1.8)
text(32.25,-5.5,"Garden")
lmod.pet <- lm(p50~pet,data=ovc.data.individuals[ovc.data.individuals$tissue == "leaf" & ovc.data.individuals$site == "W",])
summary(lmod.pet)
box(lwd=0.8)
xv <- seq(from=30,to=36,by=0.05)
yv <- predict(lmod.pet,newdata=data.frame(pet=xv))
lines(yv~xv,lwd=1.2, lty=2, col=addTrans("purple",80))
axis(side=1,labels=F,tick=T,lwd=0.8)
axis(side=2,labels=T,tick=T,lwd=0.8,las=1)
# arrows(pet.pops, p50.means[2,,1]+p50.means.se[2,,1],pet.pops,p50.means[2,,1]-p50.means.se[2,,1],code=3, angle=90,length=0.01, col="purple")
# points(p50.means[2,,1]~pet.pops,ylim=c(-6,0),pch=15,xaxt="n",yaxt="n",col="purple",cex=1.2)
points(p50~pet,data=ovc.data.individuals[ovc.data.individuals$tissue == "leaf" & ovc.data.individuals$site == "H",],ylim=c(-6,0),pch=16,xaxt="n",yaxt="n",col="orange")
lmod.pet <- lm(p50~pet,data=ovc.data.individuals[ovc.data.individuals$tissue == "leaf" & ovc.data.individuals$site == "H",])
xv <- seq(from=30,to=36,by=0.05)
yv <- predict(lmod.pet,newdata=data.frame(pet=xv))
lines(yv~xv,lwd=1.5, lty=1, col="orange")
summary(lmod.pet)
# summary(lm.pet)
mtext(side=1,line=2,outer=T,expression(paste("Historical Mean Max. Temp. for pet (",degree,"C)")))
mtext(side=2,line=2,outer=T,expression(paste(P[50]," (MPa)")))
text(31,-1.75,"Leaves")
text(30,-0.15,"a",font=2)
legend(30.5,-0.05, c("Wild","Garden","Individual","Pop. mean"), pch=c(15,15,1,15), col=c("purple","orange", "black", "black"), ncol=2)
# Stems
plot(p50~pet,data=ovc.data.individuals[ovc.data.individuals$tissue == "stem" & ovc.data.individuals$site == "W",],axes=F,ylim=c(-6,0),xlim=c(30,36),pch=16,xaxt="n",yaxt="n",col="purple")
lmod.pet <- lm(p50~pet,data=ovc.data.individuals[ovc.data.individuals$tissue == "stem" & ovc.data.individuals$site == "W",])
# abline(lmod.pet, lwd=1.5, lty=2, col="purple")
summary(lmod.pet)
box(lwd=0.8)
axis(side=1,labels=T,tick=T,lwd=0.8)
axis(side=2,labels=T,tick=T,lwd=0.8,las=1)
# arrows(pet.pops, p50.means[2,,2]+p50.means.se[2,,2],pet.pops,p50.means[2,,2]-p50.means.se[2,,2],code=3, angle=90,length=0.01, col="purple")
# points(p50.means[2,,2]~pet.pops,ylim=c(-6,0),xlim=c(600,1000),pch=15,xaxt="n",yaxt="n",col="purple",cex=1.2)
points(p50~pet,data=ovc.data.individuals[ovc.data.individuals$tissue == "stem" & ovc.data.individuals$site == "H",],ylim=c(-6,0),xlim=c(600,1000),pch=16,xaxt="n",yaxt="n",col="orange")
lmod.pet <- lm(p50~pet,data=ovc.data.individuals[ovc.data.individuals$tissue == "stem" & ovc.data.individuals$site == "H",])
# abline(lmod.pet, lwd=1.5, lty=2, col="orange")
summary(lmod.pet)
# arrows(pet.pops, p50.means[1,,2]+p50.means.se[1,,2],pet.pops,p50.means[1,,2]-p50.means.se[1,,2],code=3, angle=90,length=0.01, col="orange")
# points(p50.means[1,,2]~pet.pops,ylim=c(-6,0),xlim=c(600,1000),pch=15,col="orange")
lm.pet <- lm(p50.means[1,,2]~pet.pops)
# summary(lm.pet)
text(31,-1.75,"Stems")
text(30,-0.25,"b",font=2)
dev.off()

###########
### JJA ###
###########
tiff(filename = "FigX P50 jja.tif",
     width = 7, height = 12, units = "cm", pointsize = 8,
     compression = c("lzw"),
     bg = "white", res = 1200, family = "", restoreConsole = TRUE,
     type = c("windows", "cairo"),antialias = "cleartype")
# P50 and jja
par(mfrow=c(2,1),oma=c(4,4,0.4,0.4),mar=c(0.55,1,0.1,0.1),mgp=c(3,0.5,0))
# leaves
plot(p50~aet,data=ovc.data.individuals[ovc.data.individuals$tissue == "leaf" & ovc.data.individuals$site == "W",],axes=F,ylim=c(-6,0),xlim=c(280,500),pch=16,xaxt="n",yaxt="n",col="purple")
arrows(meta.data[meta.data$newpopnumber=="H",16],-5,meta.data[meta.data$newpopnumber=="H",16],-6,code=2,length=0.05,angle=45,lwd = 1.8)
text(420,-5.5,"Garden")
lmod.aet <- lm(p50~aet,data=ovc.data.individuals[ovc.data.individuals$tissue == "leaf" & ovc.data.individuals$site == "W",])
summary(lmod.aet)
box(lwd=0.8)
xv <- seq(from=290,to=490,by=1)
yv <- predict(lmod.aet,newdata=data.frame(aet=xv))
lines(yv~xv,lwd=1.2, lty=2, col=addTrans("purple",80))
axis(side=1,labels=F,tick=T,lwd=0.8)
axis(side=2,labels=T,tick=T,lwd=0.8,las=1)
# arrows(aet.pops, p50.means[2,,1]+p50.means.se[2,,1],aet.pops,p50.means[2,,1]-p50.means.se[2,,1],code=3, angle=90,length=0.01, col="purple")
# points(p50.means[2,,1]~aet.pops,ylim=c(-6,0),pch=15,xaxt="n",yaxt="n",col="purple",cex=1.2)
points(p50~aet,data=ovc.data.individuals[ovc.data.individuals$tissue == "leaf" & ovc.data.individuals$site == "H",],ylim=c(-6,0),pch=16,xaxt="n",yaxt="n",col="orange")
lmod.aet <- lm(p50~aet,data=ovc.data.individuals[ovc.data.individuals$tissue == "leaf" & ovc.data.individuals$site == "H",])
yv <- predict(lmod.aet,newdata=data.frame(aet=xv))
lines(yv~xv,lwd=1.5, lty=2, col="orange")
summary(lmod.aet)
# summary(lm.aet)
mtext(side=1,line=2,outer=T,expression(paste("Historical Mean AET (mm)")))
mtext(side=2,line=2,outer=T,expression(paste(P[50]," (MPa)")))
text(310,-1.75,"Leaves")
text(300,-0.15,"a",font=2)
legend(310,-0.05, c("Wild","Garden","Individual","Pop. mean"), pch=c(15,15,1,15), col=c("purple","orange", "black", "black"), ncol=2)
# Stems
plot(p50~aet,data=ovc.data.individuals[ovc.data.individuals$tissue == "stem" & ovc.data.individuals$site == "W",],axes=F,ylim=c(-6,0),xlim=c(290,500),pch=16,xaxt="n",yaxt="n",col="purple")
lmod.aet <- lm(p50~aet,data=ovc.data.individuals[ovc.data.individuals$tissue == "stem" & ovc.data.individuals$site == "W",])
abline(lmod.aet, lwd=1.5, lty=2, col="purple")
summary(lmod.aet)
box(lwd=0.8)
axis(side=1,labels=T,tick=T,lwd=0.8)
axis(side=2,labels=T,tick=T,lwd=0.8,las=1)
# arrows(aet.pops, p50.means[2,,2]+p50.means.se[2,,2],aet.pops,p50.means[2,,2]-p50.means.se[2,,2],code=3, angle=90,length=0.01, col="purple")
# points(p50.means[2,,2]~aet.pops,ylim=c(-6,0),xlim=c(600,1000),pch=15,xaxt="n",yaxt="n",col="purple",cex=1.2)
points(p50~aet,data=ovc.data.individuals[ovc.data.individuals$tissue == "stem" & ovc.data.individuals$site == "H",],ylim=c(-6,0),xlim=c(600,1000),pch=16,xaxt="n",yaxt="n",col="orange")
lmod.aet <- lm(p50~aet,data=ovc.data.individuals[ovc.data.individuals$tissue == "stem" & ovc.data.individuals$site == "H",])
xv <- seq(from=290,to=490,by=1)
yv <- predict(lmod.aet,newdata=data.frame(aet=xv))
lines(yv~xv,lwd=1.2, lty=2, col=addTrans("orange",80))
# abline(lmod.aet, lwd=1.5, lty=2, col="orange")
summary(lmod.aet)
# arrows(aet.pops, p50.means[1,,2]+p50.means.se[1,,2],aet.pops,p50.means[1,,2]-p50.means.se[1,,2],code=3, angle=90,length=0.01, col="orange")
# points(p50.means[1,,2]~aet.pops,ylim=c(-6,0),xlim=c(600,1000),pch=15,col="orange")
text(310,-1.75,"Stems")
text(300,-0.25,"b",font=2)
dev.off()

# Statistics
# Temperature
l.w.p50 <- ovc.data.individuals[ovc.data.individuals$tissue == "leaf" & ovc.data.individuals$site == "W",]
lmod.tmax <- lmer(p50~tmax + (1|pop),data=l.w.p50,REML = F)
summary(lmod.tmax)

l.g.p50 <- ovc.data.individuals[ovc.data.individuals$tissue == "leaf" & ovc.data.individuals$site == "H",]
lmod.tmax <- lmer(p50~tmax + (1|pop),data=l.g.p50,REML = F)
summary(lmod.tmax)

s.w.p50 <- ovc.data.individuals[ovc.data.individuals$tissue == "stem" & ovc.data.individuals$site == "W",]
lmod.tmax <- lmer(p50~tmax + (1|pop),data=s.w.p50,REML = F)
summary(lmod.tmax)

s.g.p50 <- ovc.data.individuals[ovc.data.individuals$tissue == "stem" & ovc.data.individuals$site == "H",]
lmod.tmax <- lmer(p50~tmax + (1|pop),data=s.g.p50)
summary(lmod.tmax)
# CWD
l.w.p50 <- ovc.data.individuals[ovc.data.individuals$tissue == "leaf" & ovc.data.individuals$site == "W",]
lmod.cwd <- lmer(p50~cwd + (1|pop),data=l.w.p50,REML = F)
lmod.pop <- lmer(p50~ (1|pop), data=l.w.p50, REML = F)
summary(lmod.pop)
anova(lmod.cwd, lmod.pop)
AIC(lmod.cwd,lmod.pop)

l.g.p50 <- ovc.data.individuals[ovc.data.individuals$tissue == "leaf" & ovc.data.individuals$site == "H",]
lmod.cwd <- lmer(p50~cwd + (1|pop),data=l.g.p50,REML = F)
summary(lmod.cwd)
lmod.pop <- lmer(p50~ (1|pop), data=l.g.p50, REML = F)
summary(lmod.pop)
anova(lmod.cwd, lmod.pop)
AIC(lmod.cwd,lmod.pop)


s.w.p50 <- ovc.data.individuals[ovc.data.individuals$tissue == "stem" & ovc.data.individuals$site == "W",]
lmod.tmax <- lmer(p50~cwd + (1|pop),data=s.w.p50,REML = F)
summary(lmod.tmax)

s.g.p50 <- ovc.data.individuals[ovc.data.individuals$tissue == "stem" & ovc.data.individuals$site == "H",]
lmod.tmax <- lmer(p50~cwd + (1|pop),data=s.g.p50,REML = F)
summary(lmod.tmax)


getwd()