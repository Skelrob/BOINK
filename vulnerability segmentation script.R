# Vulnerability segmentation 
# Blue oak
setwd("E:/")

all.ovc <- read.table("Finalrevised2analysis_Qd2018RPS.txt",header=T)
all.ovc.leaf <- all.ovc[all.ovc$tissue == "leaf",]
all.ovc.stem <- all.ovc[all.ovc$tissue %in% c("stem","Stem"),]
names(all.ovc.stem)
all.ovc.stem$lwp_MPa <- round(all.ovc.stem$lwp_MPa,2)

tiff(filename="FigX vulnerability seg.tif", 
     width=10, height=10, units="cm",
     pointsize=10, compression=c("lzw"), bg= "white",
     res=1200,family="", restoreConsole = T, type=c("windows"), 
     antialias="cleartype")

par(mfrow=c(1,1), oma=c(4,4,0.1,0.1),mar=c(1,1,0.1,0.1))
hm.y <- tapply(all.ovc.stem$percentembolism_.,all.ovc.stem$lwp_MPa,mean, na.rm=T)
hm.y.se <- tapply(all.ovc.stem$percentembolism_.,all.ovc.stem$lwp_MPa,se)
hm.x <- tapply(all.ovc.stem$lwp_MPa,all.ovc.stem$lwp_MPa,mean, na.rm=T)
y <- as.vector(hm.y)
x <- as.vector(hm.x)
plot(hm.y~hm.x, pch="", axes=F, xlim=c(-7,0), col="saddlebrown")
the <- hm.y + hm.y.se
then <- hm.y - hm.y.se
arrows(hm.x,the,hm.x,then,code=3, length=0.005, angle=90, col="lightgrey")
plcmod_qd_s <- nls(y~100-100/(1+exp(a*(hm.x-b))), start=list(a=-4,b=-5))
xv.1 <- seq(from=-7,to=0,by=0.01)
yv.1 <- predict(plcmod_qd_s,data.frame(hm.x=xv.1))
lines(xv.1,yv.1, xlim=c(-7,0), col="saddlebrown",lwd=4)

names(all.ovc.leaf)
all.ovc.leaf$lwp_MPa <- round(all.ovc.leaf$lwp_MPa,2)
hm.y <- tapply(all.ovc.leaf$percentembolism_.,all.ovc.leaf$lwp_MPa,mean, na.rm=T)
hm.y.se <- tapply(all.ovc.leaf$percentembolism_.,all.ovc.leaf$lwp_MPa,se)
hm.x <- tapply(all.ovc.leaf$lwp_MPa,all.ovc.leaf$lwp_MPa,mean, na.rm=T)
y <- as.vector(hm.y)
x <- as.vector(hm.x)
par(new=T)
plot(hm.y~hm.x, pch="", axes=F, xlim=c(-7,0), col="darkgreen")
the <- hm.y + hm.y.se
then <- hm.y - hm.y.se
arrows(hm.x,the,hm.x,then,code=3, length=0.005, angle=90, col="darkgrey")
plcmod_qd_l <- nls(y~100-100/(1+exp(a*(hm.x-b))), start=list(a=-4,b=-5))
xv.1 <- seq(from=-7,to=0,by=0.01)
yv.1 <- predict(plcmod_qd_l,data.frame(hm.x=xv.1))
lines(xv.1,yv.1, xlim=c(-7,0), col="darkgreen",lwd=4)

hm.y <- tapply(all.ovc.stem$percentembolism_.,all.ovc.stem$lwp_MPa,mean, na.rm=T)
hm.y.se <- tapply(all.ovc.stem$percentembolism_.,all.ovc.stem$lwp_MPa,se)
hm.x <- tapply(all.ovc.stem$lwp_MPa,all.ovc.stem$lwp_MPa,mean, na.rm=T)
y <- as.vector(hm.y)
x <- as.vector(hm.x)
the <- hm.y + hm.y.se
then <- hm.y - hm.y.se
plcmod_qd <- nls(y~100-100/(1+exp(a*(hm.x-b))), start=list(a=-4,b=-5))
xv.1 <- seq(from=-7,to=0,by=0.01)
yv.1 <- predict(plcmod_qd,data.frame(hm.x=xv.1))
lines(xv.1,yv.1, xlim=c(-7,0), col="saddlebrown",lwd=4)

box()
axis(side=1,labels=T,tick=T)
axis(side=2,labels=T,tick=T,las=1)
mtext(side=1,outer=T,"Stem water potential (MPa)",line=2,at=0.5)
mtext(side=2,outer=T,"Percent embolism (% of total events)",line=2,at=0.5,las=0)
text(-3.45,84.5,"WP (MPa)",srt=90)
text(-1.15,50,"Tissue")
legend(-6.7,20,c("Leaf","Stem"),lty=1,col=c("darkgreen","saddlebrown"),cex=1.1)

text(-6,88,expression(paste(P[88])))
text(-2.2,12,expression(paste(P[12])))
text(-4.7,50,expression(paste(P[50])))
# Adding an inset figure showing summary data for critical points
u <- par("usr")
v <- c(
  grconvertX(u[1:2],"user","ndc"),
  grconvertY(u[3:4],"user","ndc")
)
v <- c( (v[1]+v[2])/1.8,v[2],(v[3]+v[4])/1.8,v[4])
# Summary data

pe.tissue <- tapply(ovc.data.individuals$p12,ovc.data.individuals$tissue, mean,na.rm=T)
t.test(ovc.data.individuals$p12[ovc.data.individuals$tissue == "leaf"],ovc.data.individuals$p12[ovc.data.individuals$tissue == "stem"])
p50.tissue <- tapply(ovc.data.individuals$p50,ovc.data.individuals$tissue, mean,na.rm=T)
t.test(ovc.data.individuals$p50[ovc.data.individuals$tissue == "leaf"],ovc.data.individuals$p50[ovc.data.individuals$tissue == "stem"])
p88.tissue <- tapply(ovc.data.individuals$p88,ovc.data.individuals$tissue, mean,na.rm=T)
t.test(ovc.data.individuals$p88[ovc.data.individuals$tissue == "leaf"],ovc.data.individuals$p88[ovc.data.individuals$tissue == "stem"])

pe.tis.se <- tapply(ovc.data.individuals$p12,ovc.data.individuals$tissue, se)
p50.tis.se <- tapply(ovc.data.individuals$p50,ovc.data.individuals$tissue, se)
p88.tis.se <- tapply(ovc.data.individuals$p88,ovc.data.individuals$tissue, se)

x <- c(1,2)
par(new=T,fig=v,mar=c(0,0,0,0))
plot(pe.tissue~x,xlim=c(0.5,2.5),ylim=c(-6,-2),las=1,axes=F,pch=15,col=c("darkgreen","saddlebrown"))
arrows(x, pe.tissue+pe.tis.se, x,pe.tissue-pe.tis.se, code=3, angle=90, length=0.005,col=c("lightgrey","darkgrey"))
par(new=T,fig=v,mar=c(0,0,0,0))
plot(pe.tissue~x,xlim=c(0.5,2.5),ylim=c(-6,-2),las=1,axes=F,pch=15,col=c("darkgreen","saddlebrown"))
text(1.5,-2.5,"*")
text(1.5,-2.9,expression(paste(P[12])))
box(lwd=0.8)
arrows(x, p50.tissue+p50.tis.se, x,p50.tissue-p50.tis.se, code=3, angle=90, length=0.005,col=c("lightgrey","darkgrey"))
par(new=T,fig=v,mar=c(0,0,0,0))
plot(p50.tissue~x,xlim=c(0.5,2.5),ylim=c(-6,-2),las=1,axes=F,pch=15,col=c("darkgreen","saddlebrown"))
text(1.5,-4.1,expression(paste(P[50])))
text(1.5,-3.7,"**")
arrows(x, p88.tissue+p88.tis.se, x,p88.tissue-p88.tis.se, code=3, angle=90, length=0.005,col=c("lightgrey","darkgrey"))
par(new=T,fig=v,mar=c(0,0,0,0))
plot(p88.tissue~x,xlim=c(0.5,2.5),ylim=c(-6,-2),las=1,axes=F,pch=15,col=c("darkgreen","saddlebrown"))
text(1.5,-4.9,"***")
text(1.5,-5.3,expression(paste(P[88])))
axis(side=2,las=1,lwd=0.8)
axis(side=1,labels=c("Leaf","Stem"), at=x)
dev.off()
getwd()
